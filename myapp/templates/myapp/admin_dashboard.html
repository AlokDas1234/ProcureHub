

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">


    <title>Admin Dashboard</title>

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/css/bootstrap-select.min.css">

<!-- Bootstrap JS + jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/js/bootstrap-select.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;


        }
        .container {
            display: flex;
            justify-content: space-between;
            padding: 5px;

        }
        .left,.middle, .right {
            width: 100%;
            padding: 2px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .left h2, .right h2 {
            text-align: center;
        }
        p {
            margin: 0px 0;
        }
        .progress-bar {
  transition: width 0.5s ease;
}

<!--.requirement-card {-->
<!--    display: flex;-->
<!--    align-items: stretch; /* Ensure children take full height */-->
<!--    border-radius: 8px;-->
<!--    overflow: hidden;-->
<!--&lt;!&ndash;    margin-bottom: 1rem;&ndash;&gt;-->
<!--}-->
.requirement-card {
    display: flex;
    flex-direction: row;  /* <-- ensure children are side by side */
    align-items: stretch; /* children take full height */
    border-radius: 8px;
    overflow: hidden;
    /* margin-bottom: 1rem; */
}


<!--.vertical-label {-->
<!--    writing-mode: vertical-rl;-->
<!--    transform: rotate(180deg);-->
<!--    background-color: #1f4061;-->
<!--    color: white;-->
<!--    font-weight: bold;-->
<!--    text-align: center;-->
<!--    display: flex;-->
<!--    align-items: center;   /* Center text vertically in strip */-->
<!--    justify-content: center; /* Center text horizontally in strip */-->
<!--    padding: 0 10px;-->
<!--    height: 100%;           /* Take full height of parent */-->
<!--    min-width: 50px;        /* Consistent strip width */-->
<!--    font-size: 30px;-->
<!--}-->

<!--.vertical-label {-->
<!--    writing-mode: vertical-rl;-->
<!--    transform: rotate(180deg);-->
<!--    background-color: #1f4061;-->
<!--    color: white;-->
<!--    font-weight: bold;-->
<!--    text-align: center;-->
<!--    display: flex;-->
<!--    align-items: center;   /* Center text vertically */-->
<!--    justify-content: center;-->
<!--    padding: 10px 5px;-->
<!--    min-width: 40px;       /* fixed side strip width */-->
<!--    font-size: 16px;       /* reduce so it doesn‚Äôt stretch too much */-->
<!--    flex-shrink: 0;        /* prevents shrinking, keeps fixed width */-->
<!--    height: auto;          /* let it grow with text, not force 100% */-->
<!--}-->



.vertical-label {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    background-color: #1f4061;
    color: white;
    font-weight: bold;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 5px;
    min-width: 40px;
    font-size: 16px;
    flex-shrink: 0;
    height: auto; /* change to 100% if you want full height of card */
}



.access-toggle {
    display: flex;
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid #ccc;
    background: #eaeaea;
    width: 100%;
}

.toggle-btn {
    flex: 1;
    padding: 8px 20px;
    border: none;
    background: transparent;
    color: #555;
    font-weight: bold;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.toggle-btn.active.yes {
    background: #1a8276;
    color: white;
    box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
}

.toggle-btn.active.no {
    background: #dc3545;
    color: white;
    box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
}

.toggle-btn:not(.active) {
    opacity: 0.6;
}

.toggle-btn-cel {
    flex: 1;
     padding: 8px 20px;
    border: none;
    background: transparent;
    color: #555;
    font-weight: bold;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.toggle-btn-cel.active.yes {
    background: #1a8276;
    color: white;
    box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
}

.toggle-btn-cel.active.no {
    background: #dc3545;
    color: white;
    box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
}

.toggle-btn-cel:not(.active) {
    opacity: 0.6;
}


.toggle-btn-dec {
    flex: 1;
    padding: 8px 20px;
    border: none;
    background: transparent;
    color: #555;
    font-weight: bold;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.toggle-btn-dec.active.yes {
    background: #1a8276;
    color: white;
    box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
}

.toggle-btn-dec.active.no {
    background: #dc3545;
    color: white;
    box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
}

.toggle-btn-dec:not(.active) {
    opacity: 0.6;
}
@media (max-width: 576px) {
  /* Tighter vertical spacing */
  .form-group,
  .mb-3 {
    margin-bottom: 0.5rem !important;
  }

  /* Labels smaller but still readable */
  .form-label {
    font-size: 0.85rem;
    margin-bottom: 0.25rem; /* tighten gap */
    display: block;
  }

  /* Inputs: shorter height + smaller text */
  .form-control {
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
    border-radius: 4px;
  }

  /* Headings inside forms */
  h5 {
    font-size: 1rem;
<!--    margin-bottom: 0.5rem;-->
  }

  strong {
    font-weight: 600; /* softer bold */
  }

  /* Buttons: compact but clickable */
  .btn {
    padding: 0.4rem 0.75rem;
    font-size: 0.9rem;
    border-radius: 6px;
  }

  /* Reduce card padding */
  .card.p-4 {
    padding: 1rem !important;
  }
}


</style>
    <style>
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}

<!--#start_status {-->
<!--  display: block;             /* block-level element */-->
<!--  min-height: 1.8em;          /* fixes vertical flicker */-->
<!--  min-width: 280px;           /* reserve width for longest string */-->
<!--  white-space: nowrap;        /* keep text on one line */-->
<!--  text-align: left;           /* or center, as you need */-->
<!--}-->

#start_status {
  display: block;
  min-height: 1.8em;           /* reserve height for flicker-free updates */
  min-width: 60%;              /* relative to parent container */
  white-space: nowrap;         /* prevent line breaks */
  text-align: center;          /* looks good on both mobile & desktop */
  overflow: hidden;            /* prevent overflow issues */
}

</style>


</head>
<body >
<h1 style="text-align:center;"><span style="background-color:#1a1714;color:#1bd4fb">PROCURE </span> <span style="background-color:#1bd4fb;">HUB</span></h1>
   <style>
.gradient-hr {
    height: 4px;
    border: none;
    background: linear-gradient(to right, #4dddf0, #4b93eb);
    border-radius: 2px;
}
</style>

<hr class="gradient-hr">


<div class="d-flex justify-content-end align-items-center mb-1">
    <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=random&color=fff"
         alt="{{ user.username }}"
         class="rounded-circle"
         width="30" height="30">
    <p class="ml-2 mb-0">{{ user.username }}</p>
</div>
<div class="d-flex justify-content-end mb-3">
    <a href="{% url 'logout' %}" >Logout</a>
</div>



<!-- Include Bootstrap CSS in your <head> -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">




<!--<form style="background-color:#28414D; border: 2px solid #888;  color:white;  border-radius: 5px;" class="col-12 mx-auto  card p-3 shadow-sm" id="requisition-update" method="POST" action="{% url 'requirements' %}">-->
<!--    {% csrf_token %}-->

<!--    <div class="container-fluid mt-4" >-->

<!--         <h3 class="mb-4 text-primary font-weight-bold">1.SINGLE REQUIREMENT ENTRY:</h3>-->
<!--              <hr class="gradient-hr">-->

<!--        <div class="row" >-->
<!--    &lt;!&ndash; Left Column &ndash;&gt;-->
<!--           <div class="col-sm-3">-->
<!--                <div class="form-group">-->
<!--                    <label for="loading_point">1. Loading Point</label>-->
<!--                    <input type="text" class="form-control" name="loading_point" id="loading_point" required>-->
<!--                </div>-->
<!--                <div class="form-group">-->
<!--                    <label for="loading_point_full_address">2. Loading Point Full Address</label>-->
<!--                    <textarea class="form-control" name="loading_point_full_address" id="loading_point_full_address" rows="4" placeholder="Enter full loading address" required></textarea>-->
<!--                </div>-->
<!--                <div class="form-group">-->
<!--                    <label for="unloading_point">3.Unloading Point</label>-->
<!--                    <input type="text" class="form-control" name="unloading_point" id="unloading_point" required>-->
<!--                </div>-->
<!--                <div class="form-group">-->
<!--                    <label for="unloading_point_full_address">4. Unloading Point Full Address</label>-->
<!--                    <textarea class="form-control" name="unloading_point_full_address" id="unloading_point_full_address" rows="3.5" placeholder="Enter full unloading address" required></textarea>-->
<!--                </div>-->
<!--           </div>-->

<!--    &lt;!&ndash; Middle Column &ndash;&gt;-->
<!--            <div class="col-sm-3">-->
<!--                    <div class="form-group">-->
<!--                        <label for="truck_type">5. Truck Type</label>-->
<!--                        <input type="text" class="form-control" name="truck_type" required>-->
<!--                    </div>-->
<!--                    <div class="form-group">-->
<!--                        <label for="no_of_trucks">6. No of Trucks</label>-->
<!--                        <input type="number" class="form-control" name="no_of_trucks" required>-->
<!--                    </div>-->
<!--                    <div class="form-group">-->
<!--                        <label for="product">7. Product Type</label>-->
<!--                        <input type="text" class="form-control" name="product" required>-->
<!--                    </div>-->
<!--                    <div class="form-group">-->
<!--                        <label for="notes">8. Notes</label>-->
<!--                        <textarea class="form-control" name="notes" id="notes" rows="2" placeholder="Enter notes here"></textarea>-->
<!--                    </div>-->
<!--            </div>-->

<!--    &lt;!&ndash; Right Column &ndash;&gt;-->
<!--            <div class="col-sm-3">-->
<!--                <div class="form-group">-->
<!--                    <label for="drum_type_no_of_drums">9. Drum Type & No of Drums</label>-->
<!--                    <input type="text" class="form-control" name="drum_type_no_of_drums" required>-->
<!--                </div>-->
<!--                <div class="form-group">-->
<!--                    <label for="weight_per_drum">10. Weight per Drum</label>-->
<!--                    <input type="text" class="form-control" name="weight_per_drum" required>-->
<!--                </div>-->
<!--                <div class="form-group">-->
<!--                    <label for="approx_mat_mt">11. Approx Material Wait(MT)</label>-->
<!--                    <input type="text" class="form-control" name="approx_mat_mt" required>-->
<!--                </div>-->
<!--                <div class="form-group">-->
<!--                    <label for="types">12. Types</label>-->
<!--                    <input type="text" class="form-control" name="types" required>-->
<!--                </div>-->
<!--                <div class="form-group mb-0">-->
<!--                    <label for="cel_price">13. Ceiling Price</label>-->
<!--                    <input type="number" class="form-control" name="cel_price" required>-->
<!--                </div>-->
<!--                <div class="form-group mb-0">-->
<!--                    <label for="min_dec_val">14. Minimal Decremental value</label>-->
<!--                    <input type="number" class="form-control" name="min_dec_val" required>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->



<!--    </div>-->
<!--     <div class="d-flex justify-content-center">-->
<!--    <button style="width: 50%;" id="requisition-btn" type="submit" class="btn btn-primary px-5">Submit</button>-->
<!--</div>-->

<!--</form>-->

<!-- Bulk Upload Section -->
<!--<hr class="gradient-hr">-->



<div class=" card p-4 mt-2 mx-auto border-1" style="background-color:#28414D; border: 2px solid #888;  color:white;  border-radius: 5px;">
<h3 class="mb-4 text-primary font-weight-bold">1.BULK UPLOAD REQUIREMENTS:</h3>

<hr class="gradient-hr">
<!--     <h5 class="mb-3">New Requirement</h5>-->
<!--            <div class="access-toggle mb-4">-->
<!--                <button type="button" class="toggle-btn no" data-value="no">NO</button>-->
<!--                <button type="button" class="toggle-btn yes active" data-value="yes">YES</button>-->
<!--            </div>-->
<!--        <input type="hidden" name="access_new_req" id="accessNewReq" value="yes">-->
    <!-- Button to download template from the dynamic view -->
         <div class="col-2">
            <a href="{% url 'download_template' %}">
                <button type="button"> Download  Template</button>
            </a>
        </div>
    &nbsp
    &nbsp
    &nbsp

<input type="file" id="bulk-file" accept=".csv, .xlsx">
    &nbsp
    &nbsp
    &nbsp
    <div style="text-align:center">
<button id="bulk-upload-btn" class="btn btn-primary w-50 mb-2">Bulk Upload</button>
</div>
</div>


<div id="bulk-upload-status" style="margin-top: 15px;"></div>
{% if data.users %}
{% for user in data.users %}
<p>{{ user }}</p>
{% endfor %}
{% endif %}



<div id="upload-modal" style="
    display: none;
    position: fixed;
    top: 10%;
    left: 10%;
    width: 40%;
    height: 40%;
    background: white;
    border: 2px solid #888;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    overflow-y: auto;
    z-index: 1000;
    padding: 20px;
    border-radius: 8px;
">
    <button onclick="closeModal()" style="
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 20px;
        background: transparent;
        border: none;
        cursor: pointer;
    ">√ó</button>

    <div id="upload-result">
        <!-- Upload results will appear here -->
    </div>
</div>



<div class="card mt-5 mb-5 mx-auto border-2 ">

      <div  style="background-color:#28414D; border: 2px solid #888;  color:white;  border-radius: 5px;">
    <form  method="POST" action="{% url 'admin_dashboard' %}">
        <h3 class="mb-4 text-primary font-weight-bold">2. USER PERMISSION & POST REQUIREMENTS:</h3>
        <hr class="gradient-hr">
        {% csrf_token %}
         <label for="start_time"><strong><h5>Bidding Start Time:</h5></strong> </label>
       <input type="datetime-local" name="start_time" id="start_time" required>
          <label for="minute"> <strong><h5>Bidding Time in Minute:</h5></strong> </label>
       <input type="number" name="minute" id="minute" required>
<!--           <label for="interval"> <strong><h5>Interval:</h5></strong> </label>-->
<!--       <input type="number" name="interval" id="interval">-->
        &nbsp


<!--       <h5 class="mb-3">4. Post Requirement</h5>-->
<!--            <div class="access-toggle mb-4">-->
<!--                <button type="button" class="toggle-btn no" data-value="no">NO</button>-->
<!--                <button type="button" class="toggle-btn yes active" data-value="yes">YES</button>-->
<!--            </div>-->
        <input type="hidden" name="access" id="accessInput" value="yes">
         <h5 class="mb-3">Ceiling Price</h5>
            <div class="access-toggle mb-4">
                <button type="button" class="toggle-btn-cel no active" data-value="no">NO</button>
                <button type="button" class="toggle-btn-cel yes " data-value="yes">YES</button>
            </div>
        <input type="hidden" name="use_cel" id="useCelPrice" value="no">
        <h5 class="mb-3">Decremental Value Visibility</h5>
            <div class="access-toggle mb-4">
                <button type="button" class="toggle-btn-dec no active" data-value="no">NO</button>
                <button type="button" class="toggle-btn-dec yes " data-value="yes">YES</button>
            </div>
        <input type="hidden" name="dec_val_vi" id="decValVisibility" value="no">
        <h5 class="mb-3">Individual User Access</h5>
                <div class="form-group">
                    <label for="user">Select Users:</label>
                    <select id="userDropdown" name="user" multiple class="selectpicker"
                            data-live-search="true" data-actions-box="true">
                        <!-- Options will be added by JavaScript -->
                    </select>
                </div>

<!--        <div class="container-fluid">-->
                <div class="row">
                    <div  class="col-md-6 ">
                        <button class="btn btn-primary px-5" type="submit" style="border-radius: 8px;width:100%;">
                                       Start
                        </button>
                    </div>
                                      </form>

                     <div  class="col-md-6 mb-2 ">
                        <form  method="POST" action="{% url 'stop_bid' %}" >
                            {% csrf_token %}
                            <button class="btn btn-danger px-5"  type="submit" style="border-radius: 8px;width:100%;">
                                Stop
                            </button>
                        </form>
                         <div>

                </div>


<!--        </div>-->
                     </div>

</div>                      <form method="POST" action="{% url 'extend_page' %}">
                              {% csrf_token %}
                              <div class="row mb-5" >
                                <div class="col-md-6">
                                  <label for="extend_"><strong><h5>Extend time in minutes</h5></strong></label>
                                  <input type="number" name="extend_" id="extend_" class="form-control" required>
                                </div>

                                <div class="col-md-6 d-flex align-items-end">
                                  <button type="submit" class="btn btn-primary px-5" style="width:100%;" >Extend</button>
                                </div>
                              </div>
                            </form>
 </div>


<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container-fluid mt-3"  style="background-color:#28414D;  border-radius: 5px;">
    <div class="row">
          <div class="col-md-6   p-1">
            <h3 class="mb-4 text-primary font-weight-bold">3. BIDDING STATUS:</h3>

<!--            <h4 style="color:blue;" id="start_status"></h4>-->
<!--               <h3 id="auction_status" class="text-align:left;"></h3>-->
              <div style="display: flex; justify-content: left; width: 100%;">
  <h4 id="start_status"></h4>
   </div>

              &nbsp
        <h3 id="current_time_div" style="text-align:left;"></h3>
              &nbsp
        <h3 id="start_time_div" style="text-align:left;"></h3>
              &nbsp
        <h3 id="end_time_div" style="text-align:left;"></h3>
              &nbsp
              <h3 style="color:white;">Total requirements: {{requirements|length}}</h3>
          </div>
            <div class="col-md-6   p-1">
<!--              <img id="bidGraph" src="" style="max-width:100%; border:1px solid #ddd;" />-->
            </div>
        </div>

        <div id="refresh-container" style="text-align:center;">

             <div class="d-flex justify-content-left mt-4 mb-2 ">
                    <button onclick="window.location.reload();" class="btn btn-primary px-5"  style="border-radius: 10px;width:100%;">
                       Refresh
                    </button>
                </div>
        </div>
   </div>

        <h3 class="mb-4 mt-4 text-primary font-weight-bold">4. UPLOADED REQUIREMENTS & USER BIDS:</h3>
<hr class="gradient-hr">
    {% for requirement in requirements %}
<!--    <div class="row mb-3 align-items-stretch" >-->
       <div class="row mb-3 d-flex align-items-stretch">

        <!-- LEFT: Requirement -->
<!--        <div class="col-md-6"  >-->
            <div class="col-md-6 d-flex">
<!--            <div class="requirement-card "-->
<!--                 style="display: flex; color:white; background-color: #28414D; border-radius: 8px; overflow: hidden;">-->
<!--                 <div class="requirement-card flex-grow-1"-->
<!--             style="display: flex; flex-direction: column; background-color:#28414D; border-radius:8px; color:white;">-->
                <div class="requirement-card flex-grow-1"
     style="display: flex; flex-direction: row; background-color:#28414D; border-radius:8px; color:white;">

                        <div class="vertical-label">
                            <span>#REQUIREMENT {{ forloop.counter }}</span>
                        </div>
<!--                <div class="p-0 d-flex flex-column" style="flex: 1 1 auto; padding-bottom: 0; padding-top: 0;">-->
<!--                <div class="p-0 d-flex flex-column" style="padding: 0;">-->
                      <div class="p-0 d-flex flex-column flex-grow-1">

                        <div style="background-color: #1d2443; color: white; border-radius: 1px; margin-top: 0; padding: 0.5rem;">
                            <h2 style="margin: 0;"><strong>REQUIREMENT ID:</strong> {{ requirement.id }}</h2>
                        </div>
<!--                    <div class="p-0">-->
                                <p style="background-color: {% if not requirement.loading_point %}#EFADF0{% else %}transparent{% endif %};">
                                    <strong>Loading:</strong> {{ requirement.loading_point }}
                                </p>
                                <a href="https://www.google.com/maps/search/?api=1&query={{ requirement.loading_point_full_address|urlencode }}" target="_blank">
                                    üìç {{ requirement.loading_point_full_address }}
                                </a>
                                <p style="background-color: {% if not requirement.unloading_point %}#EFADF0{% else %}transparent{% endif %};
                                      padding-top: 10px;">
                                      <strong>Unloading:</strong> {{ requirement.unloading_point }}
                                </p>
                        <a href="https://www.google.com/maps/search/?api=1&query={{ requirement.unloading_point_full_address|urlencode }}" target="_blank">
                            üìç {{ requirement.unloading_point_full_address }}
                        </a>

                        <hr>
                        <div class="row">
                                <div class="col md-8">
                                    <p style="background-color: {% if not requirement.truck_type %}#EFADF0{% else %}transparent{% endif %};">
                                        <strong>Truck:</strong> {{ requirement.truck_type }}
                                    </p>
                                </div>

                                    <div class="col md-4">
                                        <p style="background-color: {% if not requirement.no_of_trucks %}#EFADF0{% else %}transparent{% endif %};">
                                            <strong>No of Truck:</strong> {{ requirement.no_of_trucks }}
                                        </p>
                                    </div>
                        </div>

                         <div style="display: flex; gap: 5px;">
                             <p><strong>Product Type:</strong> {{ requirement.product }}</p>
                                <p><strong>Types:</strong> {{ requirement.types }}</p>
                         </div>

             <p style="background-color: {% if not requirement.notes %}#EFADF0{% else %}transparent{% endif %};">
                <strong>Notes:</strong> {{ requirement.notes }}
            </p>
            <p><strong>Drum Type & No of Drums:</strong> {{ requirement.drum_type_no_of_drums }}</p>
            <p><strong>Weight Per Drum(kg):</strong> {{ requirement.weight_per_drum }}</p>
            <p><strong>Approx Material Wait (Mt):</strong> {{ requirement.approx_mat_mt}}</p>
            <p><strong>Requirement Date:</strong> {{ requirement.req_date}}</p><hr>
<!--                          <p><strong>Requirement Date:</strong> {{ requirement.req_date|date:"d M Y" }}</p>-->

<!--            {% if requirement.cel_price %}<p style="margin-bottom:0;padding:bottom:0;"><strong>Ceiling Price:</strong> {{ requirement.cel_price }}</p>{% endif %}-->
<!--            {% if requirement.min_dec_val %}<p style="margin-bottom:0;padding:bottom:0;"><strong>Minimal Decremental value:</strong> {{ requirement.min_dec_val }}</p>{% endif %}-->

<div style="margin: 0;">{% if requirement.cel_price %}<strong>Ceiling Price:</strong> {{ requirement.cel_price }}{% endif %}</div>
<div style="margin: 0;">{% if requirement.min_dec_val %}<strong>Minimal Decremental value:</strong> {{ requirement.min_dec_val }}{% endif %}</div>

<!--    <button style="width: 100%; margin-top: auto; padding: 0.25rem 0; border-radius: 1px; line-height: 1; display: block;"-->
<!--        onclick="delReq({{ requirement.id }})"-->
<!--        class="btn btn-sm btn-danger">-->
<!--    Delete-->
<!--</button>-->
                           <button style="width: 100%; margin-top: auto; padding: 0.25rem 0; border-radius: 1px; line-height: 1;"
                        onclick="delReq({{ requirement.id }})"
                        class="btn btn-sm btn-danger">
                    Delete
                </button>



<!--                    </div>-->

                    <!-- other fields here -->
                </div>

            </div>


        </div>




        <!-- RIGHT: Empty bid card (hidden until JS fills it) -->
<!--        <div class="col-6" >-->
              <div class="col-md-6 d-flex">
<!--            <div id="bid-card-{{ requirement.id }}"-->
<!--                 class="bid-card"-->
<!--                 style="background-color:#28414D; border-radius:8px; color:white; padding:1rem; display:none;">-->
                   <div id="bid-card-{{ requirement.id }}"
             class="bid-card flex-grow-1"
             style="background-color:#28414D; border-radius:8px; color:white; padding:1rem; display:none;">
                <!-- JS will insert bids here -->
            </div>
        </div>

    </div>
    {% endfor %}



</div>


<div class="row">
  <div class="col-md-6  text-white p-3">
      <button id="delAllReq" onclick="delReq('delAll')" class="btn btn-danger "
              style="width: 100%; margin-top: 1rem;display:none;">Delete All Requirements
      </button>

  </div>
  <div class="col-md-6 text-white p-3">
      <form method="POST" action="{% url 'delete_all_bids' %}"
            onsubmit="return confirm('‚ö†Ô∏è Are you sure you want to delete ALL bids? This action cannot be undone!');">
          {% csrf_token %}
          <button id="del_bids_btn" type="submit" class="btn btn-danger  mb-0" style="display:none; width: 100%; margin-top: 1rem;">
              Delete All Bids
          </button>
      </form>

  </div>
</div>



       <div  id ="download_bids_div" class="container mt-4 mb-4" style="display:none">
            <a  href="{% url 'download_requirements' %}" class="btn btn-primary w-100 ">
                Download Bid Report
            </a>
       </div>







<script>

    document.addEventListener("DOMContentLoaded", function() {
  const now = new Date();
  const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
    .toISOString()
    .slice(0, 16);
  document.getElementById("start_time").value = local;
  document.getElementById("minute").value = 60;
  document.getElementById("interval").value = 0;
});

    const req_len="{{requirements|length}}";
    if(req_len>0){
    let delAllReq=document.getElementById("delAllReq");
    delAllReq.style.display="block";
    }

    const user = "{{ user.username }}";
<!--    const socket = new WebSocket("ws://127.0.0.1:8000/ws/chat/room1/");-->
let wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/room1/`);
    const bidGroups = {}; // Store grouped bids
<!--    console.log("bidGroups:",bidGroups);-->

    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);

  if (data.type === 'timer_update') {
<!--        console.log("Update Timer:", data.minutes);-->

        // Convert remaining time string (e.g., "0:08:05") to seconds
        function parseTimeToSeconds(timeStr) {
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 3) { // HH:MM:SS
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            } else if (parts.length === 2) { // MM:SS
                return parts[0] * 60 + parts[1];
            }
            return 0;
        }

        const remainingSeconds = parseTimeToSeconds(data.minutes);

        // You need the totalSeconds ‚Äî pass this from server once or store globally
        const totalSeconds = window.totalAuctionSeconds || 600; // example: 10 minutes

        // Calculate percentage for progress bar
        const percent = Math.max(0, (remainingSeconds / totalSeconds) * 100);



    document.querySelectorAll('[id^="remaining-time-"]').forEach(timerEl => {
        timerEl.textContent = `Remaining Time: ${data.minutes}`;
    });

    document.querySelectorAll('[id^="progress-bar-"]').forEach(progressEl => {
        progressEl.style.width = `${percent}%`;
               });


    }

     if (data.type === 'timer_update' && data.auction_started === false) {
<!--      console.log("Auction  not Started")-->



let timer = document.getElementById("start_status");
timer.innerHTML= data.minutes
    ? `<span style="color:white; font-weight:400;">AUCTION WILL STARTS IN: ${data.minutes}</span>`
    : "\u00A0";   // keeps empty space when no text




let current_time_div = document.getElementById("current_time_div");
  current_time_div.innerHTML = `
    <span style="color:white; font-weight:400;">CURRENT TIME:</span><br>
    <span style="color:green; font-size:0.8 em; font-weight:600;">${data.clt}</span>
  `;

 let start_time_div = document.getElementById("start_time_div");
  start_time_div.innerHTML = `
    <span style="color:white; font-weight:400;">AUCTION START TIME:</span><br>
    <span style="color:green; font-size:0.8 em; font-weight:600;">${data.start_time}</span>
  `;


 let end_time_div = document.getElementById("end_time_div");
  end_time_div.innerHTML = `
    <span style="color:white; font-weight:400;">AUCTION END TIME:</span><br>
    <span style="color:green; font-size:0.8 em; font-weight:600;">${data.end_time}</span>
  `;




}

    else if (data.type === 'timer_update' && data.auction_started === true) {
<!--    console.log("Auction Started")-->



let timer = document.getElementById("start_status");
timer.innerHTML = data.minutes
    ? `  <span style="color:white; font-weight:400;">AUCTION STARTED TIME LEFT: ${data.minutes}</span><br>
   `
    : "\u00A0";   // keeps empty space when no text


let current_time_div = document.getElementById("current_time_div");
  current_time_div.innerHTML = `
    <span style="color:white; font-weight:400;">CURRENT TIME:</span><br>
    <span style="color:green; font-size:0.8 em; font-weight:600;">${data.clt}</span>
  `;

 let start_time_div = document.getElementById("start_time_div");
  start_time_div.innerHTML = `
    <span style="color:white; font-weight:400;">AUCTION START TIME:</span><br>
    <span style="color:green; font-size:0.8 em; font-weight:600;">${data.start_time}</span>
  `;


 let end_time_div = document.getElementById("end_time_div");
  end_time_div.innerHTML = `
    <span style="color:white; font-weight:400;">AUCTION END TIME:</span><br>
    <span style="color:green; font-size:0.8 em; font-weight:600;">${data.end_time}</span>
  `;



<!--    console.log("Auction Status:", data.auction_started);-->
}


else   {
<!--    let timer = document.getElementById("start_status");-->
<!--    timer.innerText = `Auction Ended !`;-->

let timer = document.getElementById("start_status");
timer.innerHTML= ` <span style="color:white; font-weight:400;">AUCTION ENDED</span><br>` || "\u00A0";

}


if (data.type === 'bids_per_requirement') {
console.log("Bid data:",data)
console.log("Bid Requirement:",data.bid_req)
<!--console.log("Bid  Top Bidders :",data.top_bidders)-->

renderBids(data);

}


 if (data.type === "bid_report_graph") {
        document.getElementById("bidGraph").src =
            "data:image/png;base64," + data.graph;
    }
       if (data.type === "normal_user") {
<!--    console.log("These are normal users who can see the requirements:", data.users);-->

    const dropdown = document.getElementById("userDropdown");

    // Clear existing options
    dropdown.innerHTML = "";

    // Add new options
    data.users.forEach(user => {
        const option = document.createElement("option");
        option.value = user;
        option.textContent = user;
        dropdown.appendChild(option);
    });

    // Refresh Bootstrap-select (if you're using it)
    if (typeof $ !== 'undefined' && typeof $('.selectpicker').selectpicker === 'function') {
        $('.selectpicker').selectpicker('refresh');
    }
}

    };


function renderBids(data) {
        let req=data.bid_req;
        const bidDiv = document.getElementById(`bid-card-${req.id}`);
        if (!bidDiv) return;
        let del_bid_btn = document.getElementById("del_bids_btn");
        let download_bid_div = document.getElementById("download_bids_div");
        if (del_bid_btn) del_bid_btn.style.display = "block";
        if (download_bid_div) download_bid_div.style.display = "block";
        bidDiv.innerHTML = `
            <h2>RECEIVED BIDS:</h2>
            <hr>
<!--            <div style="height: 45px; display: flex; background-color: transparent;">-->
<!--                <h4 id="remaining-time-${req.id}"></h4>-->
<!--            </div>-->

<!--            <div class="progress" style="height: 25px;">-->
<!--                <div id="progress-bar-${req.id}" class="progress-bar bg-success"-->
<!--                    role="progressbar" style="width: 100%;" aria-valuenow="100"-->
<!--                    aria-valuemin="0" aria-valuemax="100"></div>-->
<!--            </div>-->

<div class="progress" style="height: 25px; position: relative;">
  <!-- Shrinking green bar -->
  <div id="progress-bar-${req.id}"
       class="progress-bar bg-success"
       role="progressbar"
       style="width: 100%;"
       aria-valuenow="100"
       aria-valuemin="0"
       aria-valuemax="100">
  </div>

  <!-- Fixed text overlay -->
  <div class="progress-text"
       style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; font-weight:bold; color:#000;">
    <span id="remaining-time-${req.id}"></span>
  </div>
</div>

            <hr>
            <p><strong>Bid Req ID:</strong> ${req.id} |
            <strong>Loading:</strong> ${req.loading_point} |
            <strong>Unloading:</strong> ${req.unloading_point}</p>
            <hr>
        `;


<!--        data.top_bidders.forEach(top_bidder=>{-->

<!--            bidDiv.innerHTML += `-->
<!--                <p>-->
<!--                <strong>L${top_bidder.rank}</strong>-->
<!--                <strong>Bidder:</strong> ${top_bidder.username}-->
<!--                   </p>-->
<!--                   <p><strong>Rate:</strong> ‚Çπ${top_bidder.rate}</p>-->

<!--            `;-->
<!--             })-->

data.top_bidders.forEach(top_bidder => {
  // Define color mapping by rank
  const rankColors = {
    L1: '#130FF2',
    L2: '#245C82',
    L3: '#2B7575',
    L4: '#94318C'
  };

  // Get color for current rank (default gray if rank not found)
  const color = rankColors[`L${top_bidder.rank}`] || '#ccc';

  bidDiv.innerHTML += `
    <div style="border: 2px solid ${color};background-color:${color}; border-radius: 5px; padding: 8px; margin-bottom: 6px;">
<!--      <p style="color:${color}; font-weight:bold;">-->
        <strong>L${top_bidder.rank}</strong> - <strong>Bidder:</strong> ${top_bidder.username}
      </p>
      <p><strong>Rate:</strong> ‚Çπ${top_bidder.rate}</p>

    <!-- Admin Feedback UI -->
      <div style="background:#fff; padding:8px; border-radius:6px;">
        <label>Status: </label>
        <select id="status-${req.id}-${top_bidder.username}" class="form-control form-control-sm" style="display:inline-block; width:auto;">
          <option value=" " selected>No MSG</option>
          <option value="Approved">Approved</option>
          <option value="Higher Price">Higher Price</option>
          <option value="Rejected">Rejected</option>
          <option value="Pending">Pending</option>
        </select>
        <input id="message-${req.id}-${top_bidder.username}" class="form-control form-control-sm"
               type="text" placeholder="Enter message..." style="display:inline-block; width:60%; margin-left:8px;">
        <button class="btn btn-sm btn-primary"
                onclick="sendBidderMessage('${top_bidder.username}', ${req.id})"
                style="margin-left:6px;">Send</button>

      </div>
    </div>
  `;
});

<!--        });-->

        bidDiv.style.display = "block";
<!--    });-->
}

function sendBidderMessage(top_bidder, req_id) {
  console.log("top_bidder:", top_bidder);

  // Define element IDs
  const msg_id = `message-${req_id}-${top_bidder}`;
  const status_msg_id = `status-${req_id}-${top_bidder}`;

  // Get input values
  const msgElement = document.getElementById(msg_id);
  const statusElement = document.getElementById(status_msg_id);

  const msg = msgElement?.value.trim() || "";
  const status_msg = statusElement?.value || "";

  // Construct message payload
  const payload = {
    type: 'submit_msg',
    top_bidder: top_bidder,
    msg: msg,
    req_id: req_id,
    status_msg: status_msg
  };

  // Send through WebSocket
  socket.send(JSON.stringify(payload));
  console.log("üì§ Sent message:", payload);


  msgElement.value = "";
  statusElement.value = "";

  const toast = document.createElement("div");
  toast.textContent = "‚úÖ Message sent successfully!";
  toast.style.position = "fixed";
  toast.style.bottom = "20px";
  toast.style.right = "20px";
  toast.style.background = "#4caf50";
  toast.style.color = "white";
  toast.style.padding = "10px 15px";
  toast.style.borderRadius = "8px";
  toast.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
  toast.style.zIndex = "9999";
  document.body.appendChild(toast);

  // Remove the toast after 2 seconds
  setTimeout(() => toast.remove(), 2000);
}




   socket.onopen = function(event) {
<!--            console.log("WebSocket is open now.");-->
<!--            socket.send(JSON.stringify({ type: 'grouped_bid' }));-->
        };

    socket.onclose = () => console.log("WebSocket closed.");
    socket.onerror = err => console.error("WebSocket error:", err);

    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("requisition-update");
        const button = document.getElementById("requisition-btn");

        form.addEventListener("submit", () => {
            button.disabled = true;
            button.innerText = "Submitting...";
        });
    });

                function delReq(reqId)
                {
<!--                console.log("Req ID in delete:",reqId);-->

                   if (reqId === 'delAll')
                    {
                        const confirmedAll = confirm("Do you want to delete ALL requirements?");
                        if (!confirmedAll) {
                        return; // User canceled
                                           }
                    }
                   else {
                    const confirmed = confirm(`Do you want to delete "${reqId}" requirement?`);
                    if (!confirmed) {
                        return; // User canceled
                                     }
                         }

<!--                    console.log("reqId:", reqId);-->
                    const newForm = new FormData();
                    newForm.append("reqId", reqId);

                    fetch("{% url 'delId' %}", {
                        method: "POST",
                        body: newForm,
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}"
                        }
                    })
                    .then(res => res.text())
                    .then(data => {
<!--                        console.log("Deleted response:", data);-->
                        // Optionally remove the DOM element or reload
                        location.reload(); // or dynamically remove the element

                    })
                    .catch(error => {
                        console.error("Error deleting:", error);
                    });
                }





     function editReq(reqId) {
<!--        console.log("reqId:", reqId);-->
        const newForm = new FormData();
        newForm.append("reqId", reqId);

        fetch("{% url 'editId' %}", {
            method: "POST",
            body: newForm,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
<!--        .then(res => res.text())-->
<!--Since your server is returning JSON, but you‚Äôre parsing it as text, this will break:-->
        .then(res => res.json())
        .then(data => {
        document.getElementById("loading_point").value=data.loading_point;
<!--            console.log("Edited :", data);-->
            // Optionally remove the DOM element or reload
            location.reload(); // or dynamically remove the element

        })
        .catch(error => {
            console.error("Error deleting:", error);
        });
    }

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
   <script>
document.getElementById("bulk-upload-btn").addEventListener("click", () => {
    const fileInput = document.getElementById("bulk-file");
    const file = fileInput.files[0];
    if (!file) {
        alert("Please select a file first.");
        return;
    }

    const reader = new FileReader();
    const status = document.getElementById("bulk-upload-status");

    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: null });

        fetch("{% url 'bulk_upload_requirements' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ data: jsonData })
        })
        .then(response => response.json())
        .then(result => {
        console.log("result:",result)
            const modal = document.getElementById("upload-modal");
            const output = document.getElementById("upload-result");

            output.innerHTML = ""; // Clear previous messages

            // ‚úÖ Success message
            const success = document.createElement("p");
            success.style.color = "green";
            success.textContent = `${result.count} row(s) uploaded successfully.`;
            output.appendChild(success);

            // ‚ùå Error messages
            if (result.bulk_upload_exception.length > 0) {
                const errTitle = document.createElement("h4");
                errTitle.style.color = "red";
<!--                errTitle.textContent = "Some rows could not be uploaded:";-->
                output.appendChild(errTitle);

                result.bulk_upload_exception.forEach(ex => {
                    const p = document.createElement("p");
                    p.style.color = "red";
                    p.textContent = `Row ${ex.index}: ${ex.Exception}`;
                    output.appendChild(p);
                });
            }

            modal.style.display = "block";
        })
        .catch(error => {
            console.error("Upload error:", error);
            status.style.color = "red";
            status.textContent = "Upload failed. Please try again.";
        });
    };

    reader.readAsArrayBuffer(file);
});
</script>


<script>

function closeModal() {
    document.getElementById("upload-modal").style.display = "none";
    location.reload();  // Optional: refresh to reflect uploaded data
}
</script>


<script>
document.querySelectorAll(".toggle-btn").forEach(btn => {
    btn.addEventListener("click", function() {
        document.querySelectorAll(".toggle-btn").forEach(b => b.classList.remove("active"));
        this.classList.add("active");
        document.getElementById("accessInput").value = this.dataset.value;

    });
});

    document.querySelectorAll(".toggle-btn-cel").forEach(btn => {
    btn.addEventListener("click", function() {
        document.querySelectorAll(".toggle-btn-cel").forEach(b => b.classList.remove("active"));
        this.classList.add("active");
        document.getElementById("useCelPrice").value = this.dataset.value;
    });
});

<!-- document.querySelectorAll(".toggle-btn-cel").forEach(btn => {-->
<!--    btn.addEventListener("click", function() {-->
<!--        document.querySelectorAll(".toggle-btn-cel").forEach(b => b.classList.remove("active"));-->
<!--        this.classList.add("active");-->
<!--        document.getElementById("accessNewReq").value = this.dataset.value;-->
<!--    });-->
<!--});-->

    document.querySelectorAll(".toggle-btn-dec").forEach(btn => {
    btn.addEventListener("click", function() {
        document.querySelectorAll(".toggle-btn-dec").forEach(b => b.classList.remove("active"));
        this.classList.add("active");
        document.getElementById("decValVisibility").value = this.dataset.value;
    });
});

</script>


</body>
</html>