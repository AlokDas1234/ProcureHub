
<!DOCTYPE html>
<html lang="en">
<head>

    <title>Admin Dashboard</title>

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/css/bootstrap-select.min.css">

<!-- Bootstrap JS + jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/js/bootstrap-select.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            justify-content: space-between;
            padding: 5px;
        }
        .left,.middle, .right {
            width: 70%;
            padding: 2px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .left h2, .right h2 {
            text-align: center;
        }
        p {
            margin: 5px 0;
        }

.requirement-card {
    display: flex;
    align-items: stretch; /* Ensure children take full height */
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.vertical-label {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    background-color: #1f4061;
    color: white;
    font-weight: bold;
    text-align: center;
    display: flex;
    align-items: center;   /* Center text vertically in strip */
    justify-content: center; /* Center text horizontally in strip */
    padding: 0 10px;
    height: 100%;           /* Take full height of parent */
    min-width: 50px;        /* Consistent strip width */
    font-size: 30px;
}


.access-toggle {
    display: flex;
    border-radius: 30px;
    overflow: hidden;
    border: 2px solid #ccc;
    background: #eaeaea;
    width: fit-content;
}

.toggle-btn {
    flex: 1;
    padding: 10px 30px;
    border: none;
    background: transparent;
    color: #555;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.toggle-btn.active.yes {
    background: #28a745;
    color: white;
    box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
}

.toggle-btn.active.no {
    background: #dc3545;
    color: white;
    box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
}

.toggle-btn:not(.active) {
    opacity: 0.6;
}
</style>
    <style>
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}
</style>


</head>
<body>
<h1 style="text-align:center"><strong>PROCURE HUB</strong></h1>
   <style>
.gradient-hr {
    height: 4px;
    border: none;
    background: linear-gradient(to right, #4dddf0, #4b93eb);
    border-radius: 2px;
}
</style>

<hr class="gradient-hr">


<div class="d-flex justify-content-end align-items-center mb-1">
    <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=random&color=fff"
         alt="{{ user.username }}"
         class="rounded-circle"
         width="30" height="30">
    <p class="ml-2 mb-0">{{ user.username }}</p>
</div>
<div class="d-flex justify-content-end mb-3">
    <a href="{% url 'logout' %}" >Logout</a>
</div>



<!-- Include Bootstrap CSS in your <head> -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">



<form  class="col-10 mx-auto card p-3 shadow-sm" id="requisition-update" method="POST" action="{% url 'requirements' %}">
    {% csrf_token %}

    <div class="container-fluid mt-4">

         <h3 class="mb-4 text-primary font-weight-bold">1.SINGLE REQUIREMENT ENTRY:</h3>
                <hr>
        <div class="row">

            <!-- Left Column -->


                <div  class="form-group">
                    <div class="form-group">
                    <label for="loading_point">1. Loading Point</label>
                    <input type="text" class="form-control" name="loading_point" id="loading_point" required>
                         <label for="loading_point_full_address">3. Loading Point Full Address</label>
                    <textarea class="form-control" name="loading_point_full_address" id="loading_point_full_address" rows="4" placeholder="Enter full loading address" required></textarea>
                </div>

                            <div class="form-group">
                                <label for="unloading_point">2. Unloading Point</label>
                                <input type="text" class="form-control" name="unloading_point" id="unloading_point" required>
                            </div>



                <div class="form-group">
                    <label for="unloading_point_full_address">4. Unloading Point Full Address</label>
                    <textarea class="form-control" name="unloading_point_full_address" id="unloading_point_full_address" rows="3.5" placeholder="Enter full unloading address" required></textarea>
                </div>
            </div>

            <!-- Middle Column -->
            <div class="col-md-4 mb-4">

                <div class="form-group">
                    <label for="truck_type">5. Truck Type</label>
                    <input type="text" class="form-control" name="truck_type" required>
                </div>
                <div class="form-group">
                    <label for="no_of_trucks">6. No of Trucks</label>
                    <input type="number" class="form-control" name="no_of_trucks" required>
                </div>
<!--                <div class="form-group">-->
<!--                    <label for="qty">7. Quantity</label>-->
<!--                    <input type="number" class="form-control" name="qty" required>-->
<!--                </div>-->
                <div class="form-group">
                    <label for="product">8. Product Type</label>
                    <input type="text" class="form-control" name="product" required>
                </div>
                 <div class="form-group">
                    <label for="notes">9. Notes</label>
                    <textarea class="form-control" name="notes" id="notes" rows="2" placeholder="Enter notes here"></textarea>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-4 mb-4">

                <div class="form-group">
                    <label for="drum_type_no_of_drums">10. Drum Type & No of Drums</label>
                    <input type="text" class="form-control" name="drum_type_no_of_drums" required>
                </div>
                <div class="form-group">
                    <label for="weight_per_drum">11. Weight per Drum</label>
                    <input type="text" class="form-control" name="weight_per_drum">
                </div>
                <div class="form-group">
                    <label for="types">12. Types</label>
                    <input type="text" class="form-control" name="types">
                </div>
                <div class="form-group mb-0">
                    <label for="cel_price">13. Ceiling Price</label>
                    <input type="number" class="form-control" name="cel_price">
                </div>
                 <div class="form-group mb-0">
                    <label for="min_dec_val">14. Minimal Decremental value </label>
                    <input type="number" class="form-control" name="min_dec_val">
                </div>
            </div>
        </div>


    </div>
     <div class="d-flex justify-content-center">
    <button style="width: 50%;" id="requisition-btn" type="submit" class="btn btn-primary px-5">Submit</button>
</div>

</form>

<!-- Bulk Upload Section -->
<hr>



<div class=" card p-4 mt-2 mx-auto border-1">
<h3 class="mb-4 text-primary font-weight-bold">2.BULK UPLOAD REQUIREMENTS:</h3>

    <hr>
    <!-- Button to download template from the dynamic view -->
    <a href="{% url 'download_template' %}">
        <button type="button">Download Template</button>
    </a>
    &nbsp
    &nbsp
    &nbsp
    <input type="file" id="csvUpload" accept=".csv,.xlsx" style="display:none;" onchange="handleFileUpload(this.files[0])">

<input type="file" id="bulk-file" accept=".csv, .xlsx">
    &nbsp
    &nbsp
    &nbsp





<button id="bulk-upload-btn" class="btn btn-primary w-100 mb-2">Bulk Upload</button>

</div>


<div id="bulk-upload-status" style="margin-top: 15px;"></div>
{% if data.users %}
{% for user in data.users %}
<p>{{ user }}</p>
{% endfor %}
{% endif %}



<div id="upload-modal" style="
    display: none;
    position: fixed;
    top: 10%;
    left: 10%;
    width: 40%;
    height: 40%;
    background: white;
    border: 2px solid #888;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    overflow-y: auto;
    z-index: 1000;
    padding: 20px;
    border-radius: 8px;
">
    <button onclick="closeModal()" style="
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 20px;
        background: transparent;
        border: none;
        cursor: pointer;
    ">√ó</button>

    <div id="upload-result">
        <!-- Upload results will appear here -->
    </div>
</div>



<div class="container-fluid mt-4 mb-4">
    <form class=" col-8 card p-4 mx-auto border-2  .bg-primary.bg-gradient" method="POST" action="{% url 'admin_dashboard' %}">
        <h3 class="mb-4 text-primary font-weight-bold">3. USER PERMISSION & POST REQUIREMENTS:</h3>
        <hr>
        {% csrf_token %}
        <div class="container mt-4">
         <label for="start_time"><strong>1.Bidding Start Time:</strong> </label>
       <input type="datetime-local" name="start_time" id="start_time" required>
          <label for="minute"> <strong> 2.Bidding Time in Minute:</strong> </label>
       <input type="number" name="minute" id="minute" required>
        </div>

       <h5 class="mb-3">3. Post Requirement</h5>
        <div class="access-toggle mb-4">
            <button type="button" class="toggle-btn no" data-value="no">NO</button>
            <button type="button" class="toggle-btn yes active" data-value="yes">YES</button>

        </div>
        <input type="hidden" name="access" id="accessInput" value="yes">


        <h5 class="mb-3">4. Individual User Access</h5>
        <div class="form-group">
            <label for="user">Select Users:</label>
            <select id="userDropdown" name="user" multiple class="selectpicker"
                    data-live-search="true" data-actions-box="true">
                <!-- Options will be added by JavaScript -->
            </select>
        </div>

        <div class="d-flex justify-content-center mt-4">
            <button class="btn btn-primary px-5" type="submit" style="border-radius: 30px;">
                Grant Access/Post
            </button>
        </div>

    </form>

                </div>
</div>
<!--  </div>-->
<!--                  <form method="POST" action="{% url 'delete_all_bids' %}"-->
<!--      onsubmit="return confirm('‚ö†Ô∏è Are you sure you want to delete ALL bids? This action cannot be undone!');">-->
<!--    {% csrf_token %}-->
<!--    <button type="submit" class="btn btn-danger">-->
<!--        Delete All Bids-->
<!--    </button>-->
<!--</form>-->


<!--        </div>-->







<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container-fluid mt-1">

 <h3 class="mb-4 text-primary font-weight-bold">4.AUCTION STATUS:</h3>
    <h4 id="start_status"></h4>
<div id="refresh-container" style="text-align:center;">

     <div class="d-flex justify-content-center mt-4">
            <button onclick="window.location.reload();" class="btn btn-primary px-5"  style="border-radius: 30px;">
               Refresh
            </button>
        </div>
</div>

        <h3 class="mb-4 text-primary font-weight-bold">5. UPLOADED REQUIREMENTS & USER BIDS:</h3>

    <hr>

    {% for requirement in requirements %}
    <div class="row mb-3 align-items-stretch">

        <!-- LEFT: Requirement -->
        <div class="col-md-6">
            <div class="requirement-card h-100"
                 style="display: flex; background-color: #CED6D4; border-radius: 8px; overflow: hidden;">
                <div class="vertical-label">
                    <span>#REQUIREMENT {{ forloop.counter }}</span>

                </div>

                <div class="p-0 d-flex flex-column" style="flex: 1 1 auto; padding-bottom: 0; padding-top: 0;">
                <div style="background-color: #1d2443; color: white; border-radius: 1px; margin-top: 0; padding: 0.5rem;">
                    <h2 style="margin: 0;"><strong>REQUIREMENT ID:</strong> {{ requirement.id }}</h2>

                </div>
                    <div class="p-2">
                                <p style="background-color: {% if not requirement.loading_point %}#EFADF0{% else %}transparent{% endif %};">
                                    <strong>Loading:</strong> {{ requirement.loading_point }}
                                </p>
                                 <p><strong></strong> {{ requirement.loading_point_full_address }}</p>

                                <a href="https://www.google.com/maps/search/?api=1&query={{ requirement.loading_point_full_address|urlencode }}" target="_blank">
                                    üìç View Loading Address on Map
                                </a>
                                <p style="background-color: {% if not requirement.unloading_point %}#EFADF0{% else %}transparent{% endif %};
                                      padding-top: 10px;">
                                      <strong>Unloading:</strong> {{ requirement.unloading_point }}
                                </p>




<!--                                <p style="background-color: {% if not requirement.unloading_point %}#EFADF0{% else %}transparent{% endif %};">-->
<!--                                    <strong>Unloading:</strong> {{ requirement.unloading_point }}-->
<!--                                </p>-->


<!--                    <label  for="loading_point_full">3. Loading Point Full Address</label>-->
<!--                    <textarea class="form-control" name="loading_point_full"  rows="4" placeholder="Enter full loading address" required>"{{ requirement.loading_point_full_address }}"</textarea>-->


            <p><strong></strong> {{ requirement.unloading_point_full_address }}</p>

                <a href="https://www.google.com/maps/search/?api=1&query={{ requirement.unloading_point_full_address|urlencode }}" target="_blank">
                    üìç View Unloading Address on Map
                </a>

                        <hr>
                        <h3> Requirements:</h3>
                        <div class="row">
                            <div class="col md-8">
                                <p style="background-color: {% if not requirement.truck_type %}#EFADF0{% else %}transparent{% endif %};">
                                    <strong>Truck:</strong> {{ requirement.truck_type }}
                                </p>
                            </div>

                                <div class="col md-4">
                                    <p style="background-color: {% if not requirement.no_of_trucks %}#EFADF0{% else %}transparent{% endif %};">
                                        <strong>No of Truck:</strong> {{ requirement.no_of_trucks }}
                                    </p>
                                </div>
                        </div>
<!--           <p style="background-color: {% if not requirement.qty %}#EFADF0{% else %}transparent{% endif %};">-->
<!--                <strong>7. Qty:</strong> {{ requirement.qty }}-->
<!--            </p>-->
            <p><strong>Product Type:</strong> {{ requirement.product }}</p>

             <p style="background-color: {% if not requirement.notes %}#EFADF0{% else %}transparent{% endif %};">
                <strong>Notes:</strong> {{ requirement.notes }}
            </p>

            <p><strong>Drum Type & No of Drums:</strong> {{ requirement.drum_type_no_of_drums }}</p>
            <p><strong>Weight Per Drum(kg):</strong> {{ requirement.weight_per_drum }}</p>
            <p><strong>Types:</strong> {{ requirement.types }}</p>
                      <hr>
            <h3> Bidding Strategy:</h3>
            <p><strong>Ceiling Price:</strong> {{ requirement.cel_price }}</p>
            <p><strong>Minimal Decremental value:</strong> {{ requirement.min_dec_val }}</p>
                        </div>



                    <button style="width: 100%; margin-top: auto; border-radius: 1px; margin-bottom: 0; padding-bottom: 0;"
        onclick="delReq({{ requirement.id }})"
        class="btn btn-sm btn-danger">Delete</button>

                    <!-- other fields here -->
                </div>

            </div>
          <button
    id="delAllReq"
    onclick="delReq('delAll')"
    class="btn btn-danger "
    style="width: 100%; margin-top: 1rem;">
    Delete All Requirements
        </button>

        </div>




        <!-- RIGHT: Empty bid card (hidden until JS fills it) -->
        <div class="col-md-6">
            <div id="bid-card-{{ requirement.id }}"
                 class="bid-card h-100"
                 style="background-color:#f1f1f1; border-radius:8px; padding:1rem; display:none;">
                <!-- JS will insert bids here -->
            </div>
        </div>

    </div>
    {% endfor %}



</div>

            <div style="text-align:right">
                <form method="POST" action="{% url 'delete_all_bids' %}"
                          onsubmit="return confirm('‚ö†Ô∏è Are you sure you want to delete ALL bids? This action cannot be undone!');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger w-50 mt-3 mb-0">
                            Delete All Bids
                        </button>
                    </form>


            </div>

       <div class="container mt-4 mb-4">
            <a  href="{% url 'download_requirements' %}" class="btn btn-primary w-100 ">
                Download Bid Report
            </a>
       </div>









<script>
    const user = "{{ user.username }}";
<!--    const socket = new WebSocket("ws://127.0.0.1:8000/ws/chat/room1/");-->
let wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/room1/`);
    const bidGroups = {}; // Store grouped bids

    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);
<!--          if (data.type === 'timer_update') {-->
<!--        console.log("Update Timer:", data.minutes);-->

<!--        // Loop over all requirements and update each timer-->
<!--       Object.keys(bidGroups).forEach(reqId => {-->
<!--        const timerEl = document.getElementById(`remaining-time-${reqId}`);-->
<!--        if (timerEl) {-->
<!--            timerEl.textContent = `Remaining Time: ${data.minutes}`;-->
<!--        }-->
<!--    });-->
<!--    }-->
  if (data.type === 'timer_update') {
        console.log("Update Timer:", data.minutes);

        // Convert remaining time string (e.g., "0:08:05") to seconds
        function parseTimeToSeconds(timeStr) {
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 3) { // HH:MM:SS
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            } else if (parts.length === 2) { // MM:SS
                return parts[0] * 60 + parts[1];
            }
            return 0;
        }

        const remainingSeconds = parseTimeToSeconds(data.minutes);

        // You need the totalSeconds ‚Äî pass this from server once or store globally
        const totalSeconds = window.totalAuctionSeconds || 600; // example: 10 minutes

        // Calculate percentage for progress bar
        const percent = Math.max(0, (remainingSeconds / totalSeconds) * 100);

        Object.keys(bidGroups).forEach(reqId => {
            const timerEl = document.getElementById(`remaining-time-${reqId}`);
            if (timerEl) {
                timerEl.textContent = `Remaining Time: ${data.minutes}`;
            }

            const progressEl = document.getElementById(`progress-bar-${reqId}`);
            if (progressEl) {
                progressEl.style.width = `${percent}%`;
            }
        });
    }

     if (data.type === 'timer_update' && data.auction_started === false) {
    console.log("Update Timer:", data.minutes);
    console.log("Auction Status:",  data.auction_started);

    let timer = document.getElementById("start_status");
    timer.innerText = `Auction will start in: ${data.minutes}`;

    console.log("Auction Status:", data.auction_started);
}

    else if (data.type === 'timer_update' && data.auction_started === true) {
    console.log("Update Timer:", data.minutes);
    console.log("Auction Status:",  data.auction_started);

   let timer = document.getElementById("start_status");
  timer.innerHTML = `Auction Started Time Left <br>  ${data.minutes}`;

    console.log("Auction Status:", data.auction_started);
}


else   {

    let timer = document.getElementById("start_status");
    timer.innerText = `Auction Ended !`;


}
        if (data.type === 'bids_per_requirement') {
            const bidReq = data.bid_req;
            const reqId = bidReq.id;
            const bidder = data.bids_by;
            const bidRate = data.bid_rate;

            if (!bidGroups[reqId]) {
                bidGroups[reqId] = {
                    info: bidReq,
                    bidders: {}
                };
            }

            if (!bidGroups[reqId].bidders[bidder]) {
                bidGroups[reqId].bidders[bidder] = [];
            }

            bidGroups[reqId].bidders[bidder].push(bidRate);
            renderBids();
        }

       if (data.type === "normal_user") {
    console.log("These are normal users who can see the requirements:", data.users);

    const dropdown = document.getElementById("userDropdown");

    // Clear existing options
    dropdown.innerHTML = "";

    // Add new options
    data.users.forEach(user => {
        const option = document.createElement("option");
        option.value = user;
        option.textContent = user;
        dropdown.appendChild(option);
    });

    // Refresh Bootstrap-select (if you're using it)
    if (typeof $ !== 'undefined' && typeof $('.selectpicker').selectpicker === 'function') {
        $('.selectpicker').selectpicker('refresh');
    }
}

    };



function renderBids() {
    Object.keys(bidGroups).forEach(reqId => {
        const group = bidGroups[reqId];
        const req = group.info;

        // Find the matching bid div
        const bidDiv = document.getElementById(`bid-card-${req.id}`);
        if (!bidDiv) return; // No matching requirement

        // Start fresh
        bidDiv.innerHTML = `
            <h1>RECEIVED BIDS:</h1>
            <hr>

           <h4 id="remaining-time-${req.id}"></h4>
           <div class="progress" style="height: 20px;">
        <div id="progress-bar-${req.id}"
             class="progress-bar bg-success"
             role="progressbar"
             style="width: 100%;"
             aria-valuenow="100"
             aria-valuemin="0"
             aria-valuemax="100">
        </div>
    </div>
    <hr>
             <hr>
            <p><strong>Bid Req ID:</strong> ${req.id}</p>
            <p><strong>1.Loading:</strong> ${req.loading_point}</p>
            <p><strong>2.Unloading:</strong> ${req.unloading_point}</p>
            <hr>
        `;

        const biddersArray = Object.entries(group.bidders);

        // Sort by lowest rate
        biddersArray.sort((a, b) => {
            const minA = Math.min(...a[1]);
            const minB = Math.min(...b[1]);
            return minA - minB;
        });

        // Show top 3 bidders
        biddersArray.slice(0, 3).forEach(([bidder, rates], i) => {
            const rateStr = rates.join(" >> ‚Çπ");
            bidDiv.innerHTML += `
                <p><strong>1.Rank: L${i + 1}</strong></p>
                <p><strong>2.Bidder:</strong> ${bidder}</p>
                <p><strong>3.Rate:</strong> ‚Çπ${rateStr}</p>
                <hr>


<!--                <h3>Approve Bid</h3>-->
<!--                <label for ="bid-approve" class="switch">-->
<!--                  <input  id="bid-approve"  name="bid-approve" type="checkbox" checked>-->
<!--                  <span class="slider round"></span>-->
<!--                </label>-->

            `;
        });

        // Show the bid card



        bidDiv.style.display = "block";
    });
}


   socket.onopen = function(event) {
            console.log("WebSocket is open now.");
<!--            socket.send(JSON.stringify({ type: 'grouped_bid' }));-->

        };

    socket.onclose = () => console.log("WebSocket closed.");
    socket.onerror = err => console.error("WebSocket error:", err);

    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("requisition-update");
        const button = document.getElementById("requisition-btn");

        form.addEventListener("submit", () => {
            button.disabled = true;
            button.innerText = "Submitting...";
        });
    });

                function delReq(reqId)
                {
                console.log("Req ID in delete:",reqId);

                   if (reqId === 'delAll')
                    {
                        const confirmedAll = confirm("Do you want to delete ALL requirements?");
                        if (!confirmedAll) {
                        return; // User canceled
                                           }
                    }
                   else {
                    const confirmed = confirm(`Do you want to delete "${reqId}" requirement?`);
                    if (!confirmed) {
                        return; // User canceled
                                     }
                         }

                    console.log("reqId:", reqId);
                    const newForm = new FormData();
                    newForm.append("reqId", reqId);

                    fetch("{% url 'delId' %}", {
                        method: "POST",
                        body: newForm,
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}"
                        }
                    })
                    .then(res => res.text())
                    .then(data => {
                        console.log("Deleted response:", data);
                        // Optionally remove the DOM element or reload
                        location.reload(); // or dynamically remove the element

                    })
                    .catch(error => {
                        console.error("Error deleting:", error);
                    });
                }





     function editReq(reqId) {
        console.log("reqId:", reqId);
        const newForm = new FormData();
        newForm.append("reqId", reqId);

        fetch("{% url 'editId' %}", {
            method: "POST",
            body: newForm,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
<!--        .then(res => res.text())-->
<!--Since your server is returning JSON, but you‚Äôre parsing it as text, this will break:-->
        .then(res => res.json())
        .then(data => {
        document.getElementById("loading_point").value=data.loading_point;
            console.log("Edited :", data);
            // Optionally remove the DOM element or reload
            location.reload(); // or dynamically remove the element

        })
        .catch(error => {
            console.error("Error deleting:", error);
        });
    }

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
   <script>
document.getElementById("bulk-upload-btn").addEventListener("click", () => {
    const fileInput = document.getElementById("bulk-file");
    const file = fileInput.files[0];
    if (!file) {
        alert("Please select a file first.");
        return;
    }

    const reader = new FileReader();
    const status = document.getElementById("bulk-upload-status");

    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: null });

        fetch("{% url 'bulk_upload_requirements' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ data: jsonData })
        })
        .then(response => response.json())
        .then(result => {
            const modal = document.getElementById("upload-modal");
            const output = document.getElementById("upload-result");

            output.innerHTML = ""; // Clear previous messages

            // ‚úÖ Success message
            const success = document.createElement("p");
            success.style.color = "green";
            success.textContent = `${result.count} row(s) uploaded successfully.`;
            output.appendChild(success);

            // ‚ùå Error messages
            if (result.bulk_upload_exception.length > 0) {
                const errTitle = document.createElement("h4");
                errTitle.style.color = "red";
<!--                errTitle.textContent = "Some rows could not be uploaded:";-->
                output.appendChild(errTitle);

                result.bulk_upload_exception.forEach(ex => {
                    const p = document.createElement("p");
                    p.style.color = "red";
                    p.textContent = `Row ${ex.index}: ${ex.Exception}`;
                    output.appendChild(p);
                });
            }

            modal.style.display = "block";
        })
        .catch(error => {
            console.error("Upload error:", error);
            status.style.color = "red";
            status.textContent = "Upload failed. Please try again.";
        });
    };

    reader.readAsArrayBuffer(file);
});
</script>


<script>
<!--function loadPost() {-->
<!--    if (socket.readyState === WebSocket.OPEN) {-->
<!--        socket.send(JSON.stringify({ action: "load_requirements" }));-->
<!--    } else {-->
<!--        alert("WebSocket not ready");-->
<!--    }-->
<!--}-->

function closeModal() {
    document.getElementById("upload-modal").style.display = "none";
    location.reload();  // Optional: refresh to reflect uploaded data
}
</script>


<!--<script>-->
<!--    $(document).ready(function () {-->
<!--        $('.selectpicker').selectpicker();-->
<!--    });-->
<!--</script>-->


<script>
document.querySelectorAll(".toggle-btn").forEach(btn => {
    btn.addEventListener("click", function() {
        document.querySelectorAll(".toggle-btn").forEach(b => b.classList.remove("active"));
        this.classList.add("active");
        document.getElementById("accessInput").value = this.dataset.value;
    });
});
</script>


</body>
</html>
