<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requirements & Bids</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #111;
            color: white;
            margin: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .row {
            display: flex;
            gap: 20px;
            border: 1px solid #555;
            border-radius: 6px;
            padding: 10px;
            align-items: stretch;
        }
        .col {
            flex: 1;
            background-color: #222;
            padding: 10px;
            border-radius: 4px;
        }
        .col p {
            margin: 4px 0;
        }
        button {
            background-color: #05aafc;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #1dde8a;
        }
        input {
            padding: 4px;
            width: 80%;
        }
         a{
          color:#25ABF5
        }
        .vertical-label {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    background-color: #1f4061;
    color: white;
    font-weight: bold;
    text-align: center;
    display: flex;
    align-items: center;   /* Center text vertically in strip */
    justify-content: center; /* Center text horizontally in strip */
<!--    padding: 0 10px;-->
    height: 100%;           /* Take full height of parent */
    min-width: 50px;        /* Consistent strip width */
    margin:0px;
    font-size: 30px;
}
        .progress {
    background-color: #333;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    transition: width 0.5s ease, background-color 0.5s ease;
}

.progress-bar.green { background-color: green; }
.progress-bar.orange { background-color: orange; }
.progress-bar.red { background-color: red; }


    </style>
</head>
<body>

<h1 style="text-align:center"><strong>PROCURE HUB</strong></h1>
   <style>
.gradient-hr {
    height: 4px;
    border: none;
    background: linear-gradient(to right, #0d6efd, #6610f2);
    border-radius: 2px;
}
</style>

<hr class="gradient-hr">


<header>
    <div class="user-info">
        <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=random&color=fff"
             alt="{{ user.username }}"
             style="border-radius: 50%; object-fit: cover;"
             width="30" height="30">
        <span>{{ user.username }}</span>
    </div>
    <div class="logout">
        <a href="{% url 'logout' %}">Logout</a>
    </div>
</header>


<div id="main-container" class="container"></div>



<script>

    let allGroupedBids = {};
    let latestUserRanks = [];
    let userBids = [];   // ‚úÖ declare here

<!--    const socket = new WebSocket(`ws://127.0.0.1:8000/ws/chat/room1/`);-->
let wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/room1/`);

    socket.onopen = () => {
        console.log("WebSocket connected");
        socket.send(JSON.stringify({ action: "load_requirements" }));
        socket.send(JSON.stringify({ type: "grouped_bid" }));



    };

    function submitBid(reqId) {
        const button = document.querySelector(`#submitbid_${reqId}`);
        const bidAmtInput = document.getElementById(`bid_amt_${reqId}`);

        if (bidAmtInput && bidAmtInput.value.trim()) {
            button.disabled = true;
            socket.send(JSON.stringify({
                type: 'submit_bid',
                req_id: reqId,
                bid_amt: bidAmtInput.value.trim()
            }));

            setTimeout(() => {
                button.disabled = false;
                bidAmtInput.value = "";
                socket.send(JSON.stringify({ type: 'grouped_bid' }));
            }, 300);
        }
    }



    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("From server:", data);



if (data.type === 'timer_update') {
    console.log("Update Timer:", data.minutes);
     console.log("Auction Status:", data.auction_started);

    // Convert HH:MM:SS to seconds
    function parseTimeToSeconds(timeStr) {
        const parts = timeStr.split(':').map(Number);
        if (parts.length === 3) { // HH:MM:SS
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
        } else if (parts.length === 2) { // MM:SS
            return parts[0] * 60 + parts[1];
        }
        return 0;
    }

    const remainingSeconds = parseTimeToSeconds(data.minutes);
    const totalSeconds = window.totalAuctionSeconds || 600; // default 10 min
    const percent = Math.max(0, (remainingSeconds / totalSeconds) * 100);

    // Update all timers
    document.querySelectorAll('[id^="remaining-time-"]').forEach(timerEl => {
        timerEl.textContent = `Remaining Time: ${data.minutes}`;
    });

    // Update all progress bars
    document.querySelectorAll('[id^="progress-bar-"]').forEach(progressEl => {
        progressEl.style.width = `${percent}%`;

        // Remove old color classes
        progressEl.classList.remove('green', 'orange', 'red');

        // Add new color based on percentage
        if (percent > 50) {
            progressEl.classList.add('green');
        } else if (percent > 20) {
            progressEl.classList.add('orange');
        } else {
            progressEl.classList.add('red');
        }
    });
}





        if (data.type === 'requirements') {
            renderRequirements(data.data);
        }

<!--         if (data.type === 'grouped_bid') {-->
<!--            latestUserRanks = data.bid_group_data.user_ranks;-->
<!--            console.log("LatestUserRanks:",latestUserRanks);-->
<!--            allGroupedBids = {};-->
<!--            data.bid_group_data.bids.forEach(bid => {-->
<!--                if (!allGroupedBids[bid.id]) {-->
<!--                    allGroupedBids[bid.id] = [];-->
<!--                }-->
<!--                allGroupedBids[bid.id].push(bid.rate);-->
<!--            });-->
<!--            updateBids();-->
<!--        }-->
<!--    };-->
           if (data.type === "grouped_bid") {
        latestUserRanks = data.bid_group_data.user_ranks; // user‚Äôs best ranks
        userBids = data.bid_group_data.bids; // only this user‚Äôs bids
        console.log("latestUserRanks:",latestUserRanks);
        console.log("userBids:",userBids);
        updateBids();
    }
        };



 function renderRequirements(requirements) {

        console.log("requirements:", requirements);

        const container = document.getElementById('main-container');
        container.innerHTML = '';
          container.innerHTML=` <h2 style="text-align:center";>BIDDER DASHBOARD</h2>`;

        requirements.forEach((req, index) => {  // <-- index is here
            const row = document.createElement('div');
            row.className = 'row';
            row.id = `req_row_${req.id}`;

            const leftCol = document.createElement('div');
            leftCol.className = 'col';
            leftCol.innerHTML = `
                <div style="display: flex; align-items: stretch;">
                    <div class="vertical-label">
                        <span>#REQUIREMENT ${index + 1}</span>
                    </div>
                <div class="p-0 d-flex flex-column" style="flex: 1 1 auto; padding-bottom: 0; padding-top: 0;">
                    <div style="background-color: white; color: black; border-radius: 1px; margin-top: 0; padding: 0.2rem;">
                        <h2 style="margin: 0;"><strong>REQUIREMENT ID:</strong> ${req.id}</h2>
                    </div>
                    <div class="p-1" style="margin-left:0.25rem;">
                        <p><strong style="color: ${!req.loading_point ? '#EFADF0' : 'inherit'};">1. Loading:</strong> ${req.loading_point || ''}</p>
                        <p><strong style="color: ${!req.unloading_point ? '#EFADF0' : 'inherit'};">2. Unloading:</strong> ${req.unloading_point || ''}</p>
                        &nbsp
                        <p><strong>3. Loading Point Full Address:</strong> ${req.loading_point_full_address || ''}</p>
                        <p>
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(req.loading_point_full_address || '')}" target="_blank">
                                üìç View Loading Address on Map
                            </a>
                        </p>
                        &nbsp
                        <p><strong>4. Unloading Point Full Address:</strong> ${req.unloading_point_full_address || ''}</p>
                        <p>
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(req.unloading_point_full_address || '')}" target="_blank">
                                üìç View Unloading Address on Map
                            </a>
                        </p>
                        &nbsp
                        <hr>
                        <p><strong style="color: ${!req.truck_type ? '#EFADF0' : 'inherit'};">5. Truck:</strong> ${req.truck_type || ''}</p>
                        &nbsp
                        <p><strong style="color: ${!req.no_of_trucks ? '#EFADF0' : 'inherit'};">6. No of Truck:</strong> ${req.no_of_trucks || ''}</p>
                        &nbsp
                        <p><strong style="color: ${!req.qty ? '#EFADF0' : 'inherit'};">7. Qty:</strong> ${req.qty || ''}</p>
                        &nbsp
                        <p><strong>8. Product Type:</strong> ${req.product || ''}</p>
                        &nbsp
                        <p><strong style="color: ${!req.notes ? '#EFADF0' : 'inherit'};">9. Notes:</strong> ${req.notes || ''}</p>
                        &nbsp
                        <p><strong>10. Drum Type & No of Drums:</strong> ${req.drum_type_no_of_drums || ''}</p>
                        &nbsp
                        <p><strong>11. Weight Per Drum:</strong> ${req.weight_per_drum || ''}</p>
                        &nbsp
                        <p><strong>12. Types:</strong> ${req.types || ''}</p>
                    </div>
                </div>
                </div>
            `;

            const rightCol = document.createElement('div');
            rightCol.className = 'col';
            rightCol.innerHTML = `
            <div style="background-color: white; color: black; border-radius: 1px; margin-top: 0; padding: 0.2rem;">
                        <h2 style="margin: 0;"><strong>BIDDER REQUIREMENT ID:</strong> ${req.id}</h2>
                    </div>

                  <h3 id="remaining-time-${req.id}"></h3>
                  <div class="progress" style="height: 20px; margin-bottom: 10px;">
                   <div id="progress-bar-${req.id}"
                     class="progress-bar green"

                         role="progressbar"
                         style="width: 100%;"
                         aria-valuenow="100"
                         aria-valuemin="0"
                         aria-valuemax="100">
                    </div>
                </div>
                <hr>

                <p id="previous_bids_${req.id}" style="color: yellow;"></p>
                <p id="user_rank_${req.id}" style="color: lightgreen;"></p>


               <div style="margin-top: 5px; display: flex; gap: 2px;">
                 <input type="number" id="bid_amt_${req.id}" placeholder="Enter bid amount">
                    <button id="submitbid_${req.id}" onclick="submitBid(${req.id})">Submit Bid</button>
                    <button onclick="window.location.reload();">Refresh</button>
                    <button onclick="load_rank()">Send Grouped Bid</button>

                </div>

            `;

            row.appendChild(leftCol);
            row.appendChild(rightCol);
            container.appendChild(row);
        });

        updateBids();
    }

<!--    function updateBids() {-->
<!--        Object.keys(allGroupedBids).forEach(reqId => {-->
<!--            const field = document.getElementById(`previous_bids_${reqId}`);-->
<!--            if (field) {-->
<!--                field.textContent = `Previous Bids: ${allGroupedBids[reqId].join(' >> ')}`;-->
<!--            }-->
<!--        });-->

<!--        latestUserRanks.forEach(rank => {-->
<!--            const field = document.getElementById(`user_rank_${rank.bid_id}`);-->
<!--            if (field) {-->
<!--                field.textContent = `Your Rank: ${rank.rank} (Bid: ‚Çπ${rank.bid_rate})`;-->
<!--            }-->
<!--        });-->
<!--    }-->
function updateBids() {
    // Group this user‚Äôs bids by requirement
    const bidsByReq = {};
    userBids.forEach(bid => {
        if (!bidsByReq[bid.id]) {   // ‚úÖ use `id` instead of `req_id`
            bidsByReq[bid.id] = [];
        }
        bidsByReq[bid.id].push(bid.rate);
    });

    // Show bid history
    Object.keys(bidsByReq).forEach(reqId => {
        const field = document.getElementById(`previous_bids_${reqId}`);
        if (field) {
            field.textContent = `Rates History: ${bidsByReq[reqId].join(" >> ")}`;
        }
    });

    // Show rank
    latestUserRanks.forEach(rank => {
        const field = document.getElementById(`user_rank_${rank.bid_id}`);  // ‚úÖ use bid_id
        if (field) {
            field.textContent = `Rank: ${rank.rank} (Best Bid: ‚Çπ${rank.bid_rate})`;
        }
    });
}



function load_rank(){

    socket.send(JSON.stringify({ type: "grouped_bid" }));
    console.log("Sent grouped_bid to server");

}
</script>

</body>
</html>
