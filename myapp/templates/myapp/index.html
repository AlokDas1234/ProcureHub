<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Requirements & Bids</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #111;
            color: white;
            margin: 2px;
        }
        .container {
            display: flex;
            flex-direction: column;
<!--            gap: 2px;-->
        }
        .row {
            display: flex;
<!--            gap: 5px;-->
            border: 1px solid #555;
            border-radius: 5px;
            padding-bottom: 5px;
            align-items: stretch;
        }
        .no-border {
    border: none !important;
    padding: 0;   /* optional, removes extra spacing */
}





/* Desktop layout */
.col-left {
  flex: 0 0 100%;
  max-width: 100%;
}

}

body {
  word-wrap: break-word;
  overflow-x: hidden; /* ‚úÖ no sideways scrollbars */
}
input[type="number"] {
  padding: 4px;
  width: 100%; /* ‚úÖ take full width on mobile */
  box-sizing: border-box;
}

button {
  flex: 1; /* ‚úÖ makes buttons scale properly */
}

        input {
            padding: 4px;
            width: 80%;
        }
         a{
          color:#25ABF5
        }
        .vertical-label {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    background-color: #1f4061;
    color: white;
    font-weight: bold;
    text-align: center;
    display: flex;
    align-items: center;   /* Center text vertically in strip */
    justify-content: center; /* Center text horizontally in strip */
<!--    padding: 0 10px;-->
    height: 100%;           /* Take full height of parent */
<!--    min-width: 50px;        /* Consistent strip width */-->
    margin:0px;
    font-size: 20px;
}
        .progress {
    background-color: #333;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    transition: width 0.5s ease, background-color 0.5s ease;
}

.progress-bar.green { background-color: green; }
.progress-bar.orange { background-color: orange; }
.progress-bar.red { background-color: red; }
  .submit-btn {
        flex: 1;
        padding: 10px;
        background-color: #007bff; /* Bootstrap blue */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .submit-btn:hover {
        background-color: #0056b3;
    }

    .submit-btn:active {
        transform: scale(0.97);
        background-color: #00408d;
    }
@media (max-width: 768px) {

    /* Stack rows vertically */
    .row {
        flex-direction: column;   /* stack vertically */
        align-items: stretch;
        margin-bottom: 2px;       /* minimal spacing between rows */
        padding: 1px;             /* reduce internal padding */
        border-radius: 3px;
    }

    /* Vertical label: narrow and smaller */
    .vertical-label {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        font-size: 12px;      /* smaller font */
        width: 20px;          /* narrow strip */
        height: auto;
        padding: 1px 1px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Progress bar smaller */
    .progress {
        height: 15px;
        margin-bottom: 2px;
    }

    .progress-bar {
        height: 100%;
    }

    /* Requirement details smaller */
    .row p, .row strong {
        font-size: 11px;
        margin: 0 0 1px 0;   /* tight spacing */
    }

    /* Inputs and buttons smaller and full width */
    input[type="number"], .submit-btn {
        font-size: 10px;
        padding: 3px;
        width: 100%;
        box-sizing: border-box;
    }


    .submit-btn {
        line-height: 1.2;      /* reduce line height to shrink button */
    }
}

    /* Optional: reduce spacing in inner containers */
    .row .p-1 {
        padding: 2px 0 2px 0;
    }

    /* Optional: reduce horizontal gaps inside flex containers */
    .row > div > div {
        gap: 2px;
    }
}
</style>
</head>
<body>

<!--<h1 style="text-align:center"><strong>PROCURE HUB</strong></h1>-->

<h1 style="text-align:center;"><span style="background-color:#1a1714;color:#1bd4fb">PROCURE </span> <span style="background-color:#1bd4fb;color:#1a1714;">HUB</span></h1>
   <style>
.gradient-hr {
    height: 4px;
    border: none;
    background: linear-gradient(to right, #0d6efd, #6610f2);
    border-radius: 2px;
}
</style>

<hr class="gradient-hr">
<!--<div  class="container col-6 mx-auto p-2 shadow-lg" >-->

<header>
    <div class="user-info">
        <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=random&color=fff"
             alt="{{ user.username }}"
             style="border-radius: 50%; object-fit: cover;"
             width="30" height="30">
        <span>{{ user.username }}</span>
    </div>
    <div class="logout">
        <a href="{% url 'logout' %}">Logout</a>
    </div>


</header>
<!--   </div>-->

    <div class="container-fluid">
         <h1 style="text-align:center;">BIDDER DASHBOARD</h1>
       <h2 id="start_status" style="text-align:center; height:60px;"></h2>

        <h3 id="auction_status" class="text-align:left;"></h3>
        <h3 id="current_time_div" style="text-align:left;"></h3>
        <h3 id="start_time_div" style="text-align:left;"></h3>
        <h3 id="end_time_div" style="text-align:left;"></h3>
        <h3 id="total_req_div" style="text-align:left;"></h3>

            <div id="refresh-container" style="text-align:center;display:none;">
              <button id="refreshBtn" style="width:30%;">Refresh</button>
                &nbsp &nbsp &nbsp
            </div>
    </div>


<div id="main-container" class="container"></div>

<!--<a href="{% url 'get_bid_report' %}">Download Bid Report</a>-->

<div id="download_bids_div" class="container mt-4 mb-4 d-flex justify-content-center" style="display:none">
    <a href="{% url 'get_bid_report' %}" class="btn btn-primary w-100" style="max-width:300px;">
        Download Bid Report
    </a>
</div>



<script>
    document.getElementById("refreshBtn").addEventListener("click", () => {
  location.reload();
});

const username = "{{ request.user.username }}";
console.log("Logged-in user:", username);

window.visibleReqs = window.visibleReqs || [];

    let allGroupedBids = {};
    let latestUserRanks = [];
    let userBids = [];   // ‚úÖ declare here
<!--    console.log("allGroupedBids:",allGroupedBids);-->
<!--    console.log("latestUserRanks:",latestUserRanks);-->
<!--    console.log("userBids:",userBids);-->

<!--    const socket = new WebSocket(`ws://127.0.0.1:8000/ws/chat/room1/`);-->
let wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/room1/`);

    socket.onopen = () => {
<!--        console.log("WebSocket connected");-->
        socket.send(JSON.stringify({ action: "load_requirements" }));
        socket.send(JSON.stringify({ type: "grouped_bid" }));

    };


function submitBid(reqId) {
    const button = document.querySelector(`#submitbid_${reqId}`);
    const bidAmtInput = document.getElementById(`bid_amt_${reqId}`);

    if (bidAmtInput && bidAmtInput.value.trim()) {
        button.disabled = true;

        try {
            localStorage.removeItem("bid_amt_" + reqId);
            localStorage.removeItem("last_focused_input");
            localStorage.removeItem("last_cursor_position");
        } catch (e) {
            console.error("Failed to clear localStorage:", e);
        }

        socket.send(JSON.stringify({
            type: 'submit_bid',
            req_id: reqId,
            bid_amt: bidAmtInput.value.trim()
        }));

        // ‚úÖ Don‚Äôt clear value (keeps keyboard open)
        // Instead, auto-select so new input replaces old

        bidAmtInput.focus();
        bidAmtInput.value = "";
        bidAmtInput.select();

        setTimeout(() => {
            button.disabled = false;
        }, 300);
    }
}




let allRequirements = [];
let visibleReqIds = [];
let lastReqIdsJSON = "";
socket.addEventListener("message", function(event) {
    const data = JSON.parse(event.data);

    // 1Ô∏è‚É£ Valid bid alert
    if (data.type === "valid_bid") {
        alert(data.valid_bid);
    }


    // 2Ô∏è‚É£ Auction timer updates
    if (data.type === "timer_update") {
        const timer = document.getElementById("start_status");
        const auction_status = document.getElementById("auction_status");
        const current_time_div = document.getElementById("current_time_div");
        const start_time_div = document.getElementById("start_time_div");
        const end_time_div = document.getElementById("end_time_div");

        current_time_div.innerHTML = `<span style="color:#007BFF;font-weight:500;">CURRENT TIME:</span><br>
            <span style="color:#FAFAFA;font-size:1.2em;font-weight:600;">${data.clt}</span>`;
        start_time_div.innerHTML = `<span style="color:#007BFF;font-weight:500;">AUCTION START TIME:</span><br>
            <span style="color:#FAFAFA;font-size:1.2em;font-weight:600;">${data.start_time}</span>`;
        end_time_div.innerHTML = `<span style="color:#007BFF;font-weight:500;">AUCTION END TIME:</span><br>
            <span style="color:#FAFAFA;font-size:1.2em;font-weight:600;">${data.end_time}</span>`;

        if (data.auction_started) {
            timer.innerHTML = `<span style="color:#007BFF;font-weight:500;">REMAINING TIME:</span><br>
                <span style="color:#FAFAFA;font-size:1.2em;font-weight:600;">${data.minutes}</span>`;
            auction_status.innerHTML = `<span style="color:#007BFF;font-weight:500;">AUCTION STATUS:</span><br>
                <span style="color:#FAFAFA;font-weight:600;">Started</span>`;
            document.getElementById("refresh-container").style.display = "none";

                        // Convert HH:MM:SS to seconds
            function parseTimeToSeconds(timeStr) {
                const parts = timeStr.split(':').map(Number);
                if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
                if (parts.length === 2) return parts[0] * 60 + parts[1];
                return 0;
            }

            const remainingSeconds = parseTimeToSeconds(data.minutes);
            const totalSeconds = window.totalAuctionSeconds || 600; // default 10 min
            const percent = Math.max(0, (remainingSeconds / totalSeconds) * 100);

            // ‚úÖ Update all progress bars
            document.querySelectorAll('[id^="progress-bar-"]').forEach(progressEl => {
                progressEl.style.width = `${percent}%`;

                // Remove old color classes
                progressEl.classList.remove('green', 'orange', 'red');

                // Add new color based on percentage
                if (percent > 50) {
                    progressEl.classList.add('green');
                } else if (percent > 20) {
                    progressEl.classList.add('orange');
                } else {
                    progressEl.classList.add('red');
                }
            });

            // ‚úÖ Update remaining-time text inside progress bar
            document.querySelectorAll('[id^="remaining-time-"]').forEach(timerEl => {
                timerEl.textContent = `${data.minutes}`;
            });


        } else {
            timer.innerHTML = `Auction Will Start In:<br>${data.minutes}`;
            auction_status.innerHTML = `<span style="color:#007BFF;font-weight:500;">AUCTION STATUS:</span><br>
                <span style="color:#FAFAFA;font-weight:600;">Will Start Soon....!</span>`;
            document.getElementById("refresh-container").style.display = "block";
            if (data.seconds === 0) location.reload();
        }
    }

    // 3Ô∏è‚É£ All requirements (once)
<!--    if (data.type === "one_by_one_req") {-->
<!--        console.log("üì¶ All requirements received:", data.data);-->
<!--        window.allRequirements = data.data;-->
<!--    }-->

if (data.type === 'send_bid_msg') {
            const bid_msg = data.bid_msg;
        console.log("Bid message received:", bid_msg);

        // ‚úÖ Extract data.
        const reqId = bid_msg.req_id;
        const msgText = bid_msg.msg;
        const statusText = bid_msg.status_msg;
        // ‚úÖ Call display function.
          console.log("Bid Req Id:", reqId);
          console.log("Bid  Message Text:", msgText);
          console.log("Bid   Status Text:", statusText);
        displayBidMessage(reqId, msgText, statusText);
    }

// ‚úÖ Auto-refresh visible requirements every second
if (data.type === 'one_by_one_req') {
    const reqs = data.data;
    const postSchedule = data.post_interval_lst;
    const auction_start_status = data.auction_start_status;

    const now = new Date(data.current_local_time);

    // Show immediately visible requirements
    reqs.forEach(req => {
        const showTime = new Date(postSchedule[String(req.id)]);
        if (showTime <= now) {
            // Add to global visible list if not already present
            if (!window.visibleReqs.find(r => r.id === req.id)) {
                window.visibleReqs.push(req);
            }
        }
    });

    renderRequirements(window.visibleReqs, auction_start_status);

    // Schedule future requirements individually
    reqs.forEach(req => {
        const showTime = new Date(postSchedule[String(req.id)]);
        const delay = showTime - now;

        if (delay > 0) {
            setTimeout(() => {
                // Add the new requirement to visibleReqs
                if (!window.visibleReqs.find(r => r.id === req.id)) {
                    window.visibleReqs.push(req);
                }

                // Re-render all visible requirements
                renderRequirements(window.visibleReqs, auction_start_status);
            }, delay);
        }
    });
}

    // 5Ô∏è‚É£ Requirements refresh (interval broadcast)
    if (data.type === "requirements") {
<!--        console.log("‚úÖ Requirements received:", data.data);-->

        let total_req_div = document.getElementById("total_req_div");
        total_req_div.innerHTML = `
            <span style="color:#007BFF;font-size:1.3em;font-weight:500;">Total Requirements:</span><br>
            <span style="color:#FAFAFA;font-size:1.3em;font-weight:600;">${data.len_reqs}</span>`;

        renderRequirements(data.data, data.auction_start_status);
    }

    // 6Ô∏è‚É£ Grouped bids
    if (data.type === "grouped_bid") {
        latestUserRanks = data.bid_group_data.user_ranks;
        userBids = data.bid_group_data.bids;

        if (data.bid_group_data.len_bids > 0) {
            document.getElementById("download_bids_div").style.display = "block";
        }

        updateBids();
    }
});


<!--function displayBidMessage(reqId, msg, status, retries = 10) {-->
<!--  const msgElement = document.getElementById(`msg_${reqId}`);-->
<!--  const statusElement = document.getElementById(`status_msg_${reqId}`);-->

<!--  if (!msgElement || !statusElement) {-->
<!--    if (retries > 0) {-->
<!--      console.warn(`‚è≥ Waiting for elements of req_id=${reqId}...`);-->
<!--      setTimeout(() => displayBidMessage(reqId, msg, status, retries - 1), 500);-->
<!--    } else {-->
<!--      console.error(`‚ùå Elements for req_id=${reqId} not found after waiting.`);-->
<!--    }-->
<!--    return;-->
<!--  }-->

<!--  // ‚úÖ Once found, update content-->
<!--  msgElement.textContent = `Message: ${msg}`;-->
<!--  statusElement.textContent = `Status: ${status}`;-->
<!--}-->

function displayBidMessage(reqId, msg, status) {
  function tryDisplay(attempts = 0) {
    const msgElement = document.getElementById(`msg_${reqId}`);
    const statusElement = document.getElementById(`status_msg_${reqId}`);

    if (msgElement && statusElement) {
      msgElement.textContent = `Message: ${msg}`;
      statusElement.textContent = `Status: ${status}`;
      console.log(`‚úÖ Displayed message for req_id=${reqId}`);
    } else if (attempts < 20) {  // retry up to ~2 seconds
      console.log(`‚è≥ Waiting for elements of req_id=${reqId}...`);
      setTimeout(() => tryDisplay(attempts + 1), 100);
    } else {
      console.warn(`‚ö†Ô∏è Elements for req_id=${reqId} not found after waiting.`);
    }
  }

  tryDisplay();
}



function getCurrentInputValues() {
    const values = {};
    document.querySelectorAll('[id^="bid_amt_"]').forEach(input => {
        values[input.id] = input.value;
    });
    return values;
    }


function renderRequirements(requirements, auction_start_status) {
    const savedInputs = getCurrentInputValues();
    const scrollY = window.scrollY;
    const container = document.getElementById('main-container');
    const activeElement = document.activeElement;
    const activeId = activeElement && activeElement.id;
    const fragment = document.createDocumentFragment();

    requirements.forEach((req, index) => {
        const inputId = `bid_amt_${req.id}`;
        const inputValue = savedInputs[inputId] || '';
        const row = document.createElement('div');
        row.className = 'row';
        row.id = `req_row_${req.id}`;

        const leftCol = document.createElement('div');
        leftCol.className = 'col col-left';

        leftCol.innerHTML = `
            <div style="display: flex; align-items: stretch;">
                <div class="vertical-label">
                    <span>#REQUIREMENT ${index + 1}</span>
                </div>
                <div class="p-0 d-flex flex-column" style="flex: 1 1 auto; margin:0; padding:0;">
                    <!-- ‚úÖ your existing progress bar + requirement details -->
                    <div class="progress" style="height: 27px; margin-bottom: 10px;font-size:12px;position: relative; border-radius: 5px; overflow: hidden;">
                        <div id="progress-bar-${req.id}" class="progress-bar green" style="width: 100%; height: 100%;"></div>
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                                    display: flex; align-items: center; justify-content: center;
                                    font-weight: bold; color: white; pointer-events: none;">
                            REQUIREMENT ID: ${req.id} | <span id="remaining-time-${req.id}"></span>
                        </div>
                    </div>

                    <!-- rest of your details exactly as you have them -->
                    <div class="p-1" style="margin-left:0.5rem;">

                        <!-- keep your other fields here (unloading, product, truck type, etc.) -->

                        <div class="row no-border">
                           <div class="col-md-6">
                             <div style="display: flex; gap: 10px;">

                        <p style="margin:0;"><strong style="color: ${req.loading_point ?  '#05ACFA' : '#EFADF0'};">Loading:</strong> ${req.loading_point || ''}</p>

                      <p style="margin:0;">
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(req.loading_point_full_address || '')};" target="_blank">
                             ${ req.loading_point_full_address}
                            </a>
                        </p>
                                                </div>
                        </div>

                         <div class="col-md-6">


                          </div>
                          </div>
                              <div style="display: flex; gap: 10px;">
                            <p style="margin:0;"><strong style="color: ${req.unloading_point ?  '#05ACFA' : '#EFADF0'};">Unloading:</strong> ${req.unloading_point || ''}</p>


                        <p style="margin:0;">
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(req.unloading_point_full_address || '')};" target="_blank">
                               ${req.unloading_point_full_address}
                            </a>
                        </p>
                        </div>

                        <hr>
                        <div style="display: flex; gap: 5px;">
                                          <p style="margin:0;">
                                            <strong style="color: ${req.truck_type ? '#05ACFA' : '#EFADF0'};">Truck:</strong>
                                            ${req.truck_type || ''}
                                          </p>


                                          <p style="margin:0;">
                              <strong style="color: ${req.product ? '#05ACFA' : '#EFADF0'};">
                                Product Type:
                              </strong>
                              ${req.product || ''} with ${req.drum_type_no_of_drums || ''} Drums
                            </p>
                               <p style="margin:0;">
                                            <strong style="color: ${req.no_of_trucks ? '#05ACFA' : '#EFADF0'};">No of Truck:</strong>
                                            ${req.no_of_trucks || ''}
                                          </p>



                            <p style="margin:0;">
                          <strong style="color: ${req.types ? '#05ACFA' : '#EFADF0'};">
                            Types:
                          </strong>
                          ${req.types || ''}
                        </p>
                                        </div>




                       <div style="display: flex; gap: 5px; margin:2;">
                        <p style="margin:0;">
                              <strong style="color: ${req.approx_mat_mt ? '#05ACFA' : '#EFADF0'};">
                                Approx Material Wait (MT):
                              </strong>
                              ${req.approx_mat_mt || ''}
                            </p>

                             <p style="margin:0;">
                          <strong style="color: ${req.weight_per_drum ? '#05ACFA' : '#EFADF0'};">
                            Weight Per Drum(Kg):
                          </strong>
                          ${req.weight_per_drum || ''}
                        </p>

                        <p style="margin:0;">
                          <strong style="color: ${req.req_date ? '#05ACFA' : '#EFADF0'};">
                            Requirement Date:
                          </strong>
                          ${req.req_date || ''}
                        </p>
                                              <p style="margin:0;">
                      <strong style="color: ${req.notes ? '#05ACFA' : '#EFADF0'};">
                        Notes:
                      </strong>
                      ${req.notes || ''}
                    </p>
                        </div>


 <hr>


${(req.cel_price || req.min_dec_val) ? `
  <div style="display: flex; gap: 4px;">

    ${req.cel_price ? `
      <p style="margin:0;">
        <strong style="color:#05ACFA;">Ceiling Price:</strong>
        ${req.cel_price}
      </p>` : ''}

    ${req.min_dec_val ? `
      <p style="margin:0;">
        <strong style="color:#05ACFA;">Minimal Decremental Value:</strong>
        ${req.min_dec_val}
      </p>` : ''}

  </div>
  <hr>
` : ''}

                    </div>
                       <div style="margin:0; padding:0;">
                            <p id="previous_bids_${req.id}" style="margin:0; font-weight:bold;"></p>
                            <p id="user_rank_${req.id}" style="margin:0; color: lightgreen;"></p>


                        <div id="bid_info_${req.id }" style="display: flex; gap: 10px;">
                              <p id="msg_${req.id }" style="font-weight: bold; margin: 0;"></p>
                              <p id="status_msg_${req.id}" style="color: lightgreen; margin: 0;"></p>
                        </div>

                       </div>

                        <div id="submit_bid_amt_${req.id}" style="${auction_start_status ? '' : 'display:none;'}">
                            <div style="display: flex; gap: 2px; align-items: center;">
                                <input type="number" id="bid_amt_${req.id}" placeholder="Enter bid amount"
                                       style="flex: 1; padding: 5px; font-size: 12px;"   value="${inputValue}">
                                    <button id="submitbid_${req.id}" onclick="submitBid(${req.id})" class="submit-btn"
                                            style="flex: 2; padding: 5px; font-size: 14px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                        Submit Bid
                                    </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        row.appendChild(leftCol);
        fragment.appendChild(row);
    });



   // ‚úÖ Instead of replaceChildren (kills focus), patch manually
    if (container.children.length !== requirements.length) {
        container.replaceChildren(fragment);
    } else {
        // Update row-by-row
        requirements.forEach((req, i) => {
            const existing = container.children[i];
            const newRow = fragment.children[i];
             if (!newRow) return;
<!--            if (!existing || existing.id !== newRow.id || existing.innerHTML !== newRow.innerHTML) {-->
<!--                container.replaceChild(newRow, existing);-->
<!--            }-->
             if (!existing) {
                    container.appendChild(newRow);
                    return;
                }

                if (!existing.contains(document.activeElement)) {
        // Safe to replace when no active input inside
        if (existing.id !== newRow.id || existing.innerHTML !== newRow.innerHTML) {
            container.replaceChild(newRow, existing);
        }}

               else{
        // Just update dynamic parts instead of replacing the whole row
        // Example: update progress bar + text fields
        const newProgress = newRow.querySelector(`#progress-bar-${req.id}`);
        const oldProgress = existing.querySelector(`#progress-bar-${req.id}`);
        if (oldProgress && newProgress) {
            oldProgress.className = newProgress.className;
            oldProgress.style.width = newProgress.style.width;
        }

        const newRemain = newRow.querySelector(`#remaining-time-${req.id}`);
        const oldRemain = existing.querySelector(`#remaining-time-${req.id}`);
        if (oldRemain && newRemain) {
            oldRemain.textContent = newRemain.textContent;
        }

         const newRank = newRow.querySelector(`#user_rank_${req.id}`);
        const oldRank = existing.querySelector(`#user_rank_${req.id}`);
        if (oldRank && newRank) {
            oldRank.textContent = newRank.textContent;
        }

        // (you can add more patching here as needed)
    }



        });
    }

    // ‚úÖ If user was typing, re-focus only that input (keyboard stays open)
    if (activeId) {
        const stillThere = document.getElementById(activeId);
        if (stillThere) {
            stillThere.focus();
            // put cursor at end if it‚Äôs a number input
            if (stillThere.type === "number") {
                const val = stillThere.value;
                stillThere.value = "";
                stillThere.value = val;
            }
        }
    }

    requestAnimationFrame(() => {
        window.scrollTo(0, scrollY);
    });

    updateBids();
}





<!--}-->
function restoreInputs() {
    document.querySelectorAll('[id^="bid_amt_"]').forEach(input => {
        const savedVal = localStorage.getItem(input.id);
        if (savedVal !== null) input.value = savedVal;
    });

    // ‚ùå Remove auto-focus ‚Üí prevents unwanted scroll jump
    // const lastFocusedId = localStorage.getItem("last_focused_input");
    // if (lastFocusedId) {
    //     const focusedInput = document.getElementById(lastFocusedId);
    //     if (focusedInput) focusedInput.focus();
    // }
}


let keyboardOpen = false;

window.addEventListener("resize", () => {
    // Mobile trick: viewport height shrinks when keyboard opens
    keyboardOpen = window.innerHeight < screen.height - 100;
});

function restoreInputs() {
    document.querySelectorAll('[id^="bid_amt_"]').forEach(input => {
        const savedVal = localStorage.getItem(input.id);
        if (savedVal !== null) input.value = savedVal;
    });

    if (keyboardOpen) {
        const lastFocusedId = localStorage.getItem("last_focused_input");
        if (lastFocusedId) {
            const focusedInput = document.getElementById(lastFocusedId);
            if (focusedInput) focusedInput.focus();
        }
    }
}


// Call this after rendering your inputs



// Track toggle states for each requirement locally
const toggleState = {}; // { reqId: "all" | "less" }

function updateBids() {
    const bidsByReq = {};
    userBids.forEach(bid => {
        if (!bidsByReq[bid.id]) {
            bidsByReq[bid.id] = [];
        }
        bidsByReq[bid.id].push(bid.rate);
    });

    Object.keys(bidsByReq).forEach(reqId => {
        const field = document.getElementById(`previous_bids_${reqId}`);
        if (!field) return;
        const allRates = bidsByReq[reqId];
        const showLimit = 5;

        // Decide what to render based on saved state
        let visibleRates;
        if (toggleState[reqId] === "all") {
            visibleRates = allRates;
        } else {
            visibleRates = allRates.slice(-showLimit);
        }

        // Render
        field.innerHTML = `
            <span class="visible-rates">${visibleRates.join(" > ")}</span>
            ${allRates.length > showLimit ?
              `<button class="toggle-rates" data-req="${reqId}" style="margin-left:5px; font-size:12px;">
                  ${toggleState[reqId] === "all" ? "Show Less" : "Show All"}
               </button>`
              : ''}
        `;
    });

    // Add listeners
    document.querySelectorAll(".toggle-rates").forEach(btn => {
        btn.onclick = () => {
            const reqId = btn.getAttribute("data-req");
            const allRates = bidsByReq[reqId];

            if (toggleState[reqId] === "all") {
                // Switch to "less"
                toggleState[reqId] = "less";
                btn.textContent = "Show All";
                btn.previousElementSibling.textContent = allRates.slice(-5).join(" > ");
            } else {
                // Switch to "all"
                toggleState[reqId] = "all";
                btn.textContent = "Show Less";
                btn.previousElementSibling.textContent = allRates.join(" > ");
            }
        };
    });



    // Show rank as before
    latestUserRanks.forEach(rank => {
        const field = document.getElementById(`user_rank_${rank.bid_id}`);
        if (field) {
            field.textContent = `Rank: ${rank.rank} (Last Bid: ‚Çπ${rank.bid_rate})`;
        }
    });
}



// Save input values in localStorage whenever user types
document.addEventListener("input", (e) => {
    if (e.target.id.startsWith("bid_amt_")) {
        localStorage.setItem(e.target.id, e.target.value);
    }
});


document.addEventListener("focusin", (e) => {
    if (e.target.tagName === "INPUT" && e.target.id.startsWith("bid_amt_")) {
        localStorage.setItem("last_focused_input", e.target.id);
        // Save cursor only if input type is text (number type doesn't support it)
        if (e.target.type === "text") {
            localStorage.setItem("last_cursor_position", e.target.selectionStart || 0);
        }
    }
});





</script>

</body>
</html>
