<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Requirements & Bids</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #111;
            color: white;
<!--            margin: 20px;-->
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .row {
            display: flex;
<!--            gap: 5px;-->
            border: 1px solid #555;
            border-radius: 5px;
<!--            padding: 5px;-->
            align-items: stretch;
        }
        .no-border {
    border: none !important;
    padding: 0;   /* optional, removes extra spacing */
}

<!--.col-left {-->
<!--  flex: 0 0 70%; /* Take 70% of available width */-->
<!--  max-width: 70%;-->
<!--}-->
<!--.col-right {-->
<!--  flex: 0 0 30%; /* Take 30% of available width */-->
<!--  max-width: 30%;-->
<!--}-->

<!--/* Your existing columns */-->
<!--.col-left {-->
<!--  flex: 0 0 70%;-->
<!--  max-width: 70%;-->
<!--}-->
<!--.col-right {-->
<!--  flex: 0 0 30%;-->
<!--  max-width: 30%;-->
<!--}-->

<!--/* ✅ Make it mobile-friendly */-->
<!--@media (max-width: 768px) {-->
<!--  .row {-->
<!--    flex-direction: column; /* stack columns vertically */-->
<!--  }-->

<!--  .col-left, .col-right {-->
<!--    flex: 0 0 100%;-->
<!--    max-width: 100%;-->
<!--  }-->

<!--  .col-right {-->
<!--    margin-top: 5px; /* add spacing between left and right on mobile */-->
<!--  }-->
<!--}-->



<!--        .col {-->
<!--            flex: 1;-->
<!--            background-color: #222;-->
<!--            padding: 5px;-->
<!--            border-radius: 4px;-->
<!--        }-->
<!--        .col p {-->
<!--            margin: 4px 0;-->
<!--        }-->


/* Desktop layout */
.col-left {
  flex: 0 0 100%;
  max-width: 100%;
}

<!--.col-right {-->
<!--  flex: 0 0 30%;-->
<!--  max-width: 30%;-->
<!--}-->

/* ✅ Make it mobile-friendly */
<!--@media (max-width: 768px) {-->
<!--  .row {-->
<!--    flex-direction: column; /* stack vertically */-->
<!--    align-items: flex-start; /* ✅ stop forcing equal height */-->
<!--  }-->

<!--  .col-left,-->
<!-- {-->
<!--    flex: 1 1 100%; /* ✅ let them expand naturally */-->
<!--    max-width: 100%;-->
<!--  }-->

<!--  .col-right {-->
<!--    margin-top: 10px; /* add spacing between sections */-->
<!--  }-->
}

body {
  word-wrap: break-word;
  overflow-x: hidden; /* ✅ no sideways scrollbars */
}
input[type="number"] {
  padding: 4px;
  width: 100%; /* ✅ take full width on mobile */
  box-sizing: border-box;
}

button {
  flex: 1; /* ✅ makes buttons scale properly */
}

<!--        button {-->
<!--            background-color: #05aafc;-->
<!--            color: white;-->
<!--            border: none;-->
<!--            padding: 5px 10px;-->
<!--            border-radius: 4px;-->
<!--            cursor: pointer;-->
<!--        }-->
<!--        button:hover {-->
<!--            background-color: #1dde8a;-->
<!--        }-->
        input {
            padding: 4px;
            width: 80%;
        }
         a{
          color:#25ABF5
        }
        .vertical-label {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    background-color: #1f4061;
    color: white;
    font-weight: bold;
    text-align: center;
    display: flex;
    align-items: center;   /* Center text vertically in strip */
    justify-content: center; /* Center text horizontally in strip */
<!--    padding: 0 10px;-->
    height: 100%;           /* Take full height of parent */
<!--    min-width: 50px;        /* Consistent strip width */-->
    margin:0px;
    font-size: 20px;
}
        .progress {
    background-color: #333;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    transition: width 0.5s ease, background-color 0.5s ease;
}

.progress-bar.green { background-color: green; }
.progress-bar.orange { background-color: orange; }
.progress-bar.red { background-color: red; }
  .submit-btn {
        flex: 1;
        padding: 10px;
        background-color: #007bff; /* Bootstrap blue */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .submit-btn:hover {
        background-color: #0056b3;
    }

    .submit-btn:active {
        transform: scale(0.97);
        background-color: #00408d;
    }

    </style>
</head>
<body>

<h1 style="text-align:center"><strong>PROCURE HUB</strong></h1>
   <style>
.gradient-hr {
    height: 4px;
    border: none;
    background: linear-gradient(to right, #0d6efd, #6610f2);
    border-radius: 2px;
}
</style>

<hr class="gradient-hr">
<!--<div  class="container col-6 mx-auto p-2 shadow-lg" >-->

<header>
    <div class="user-info">
        <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=random&color=fff"
             alt="{{ user.username }}"
             style="border-radius: 50%; object-fit: cover;"
             width="30" height="30">
        <span>{{ user.username }}</span>
    </div>
    <div class="logout">
        <a href="{% url 'logout' %}">Logout</a>
    </div>


</header>
<!--   </div>-->

    <div class="container-fluid">
         <h1 style="text-align:center;">BIDDER DASHBOARD</h1>
       <h2 id="start_status" style="text-align:center; height:60px;"></h2>

        <h3 id="auction_status" class="text-align:left;"></h3>
        <h3 id="current_time_div" style="text-align:left;"></h3>
        <h3 id="start_time_div" style="text-align:left;"></h3>
        <h3 id="end_time_div" style="text-align:left;"></h3>
        <h3 id="total_req_div" style="text-align:left;"></h3>

            <div id="refresh-container" style="text-align:center;">
              <button id="refreshBtn" style="width:30%;">Refresh</button>
                &nbsp &nbsp &nbsp
            </div>
    </div>


<div id="main-container" class="container"></div>

<!--<a href="{% url 'get_bid_report' %}">Download Bid Report</a>-->

<div id="download_bids_div" class="container mt-4 mb-4 d-flex justify-content-center" style="display:none">
    <a href="{% url 'get_bid_report' %}" class="btn btn-primary w-100" style="max-width:300px;">
        Download Bid Report
    </a>
</div>



<script>
    document.getElementById("refreshBtn").addEventListener("click", () => {
  location.reload();
});


    let allGroupedBids = {};
    let latestUserRanks = [];
    let userBids = [];   // ✅ declare here
<!--    console.log("allGroupedBids:",allGroupedBids);-->
<!--    console.log("latestUserRanks:",latestUserRanks);-->
<!--    console.log("userBids:",userBids);-->

<!--    const socket = new WebSocket(`ws://127.0.0.1:8000/ws/chat/room1/`);-->
let wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/room1/`);

    socket.onopen = () => {
<!--        console.log("WebSocket connected");-->
        socket.send(JSON.stringify({ action: "load_requirements" }));
        socket.send(JSON.stringify({ type: "grouped_bid" }));

    };

<!--    function submitBid(reqId) {-->
<!--        const button = document.querySelector(`#submitbid_${reqId}`);-->
<!--        const bidAmtInput = document.getElementById(`bid_amt_${reqId}`);-->

<!--        if (bidAmtInput && bidAmtInput.value.trim()) {-->
<!--            button.disabled = true;-->
<!--            socket.send(JSON.stringify({-->
<!--                type: 'submit_bid',-->
<!--                req_id: reqId,-->
<!--                bid_amt: bidAmtInput.value.trim()-->
<!--            }));-->
<!--            setTimeout(() => {-->
<!--            bidAmtInput.value = "";-->
<!--            localStorage.removeItem("bid_amt_"+reqId);-->

<!--        }, 300);-->
<!--        }-->
<!--    }-->



function submitBid(reqId) {
    const button = document.querySelector(`#submitbid_${reqId}`);
    const bidAmtInput = document.getElementById(`bid_amt_${reqId}`);

    if (bidAmtInput && bidAmtInput.value.trim()) {
        button.disabled = true;

        // ✅ Clear storage immediately (before re-render)
        try {
            localStorage.removeItem("bid_amt_" + reqId);
            localStorage.removeItem("last_focused_input");
            localStorage.removeItem("last_cursor_position");

        } catch (e) {
            console.error("Failed to clear localStorage:", e);
        }

        socket.send(JSON.stringify({
            type: 'submit_bid',
            req_id: reqId,
            bid_amt: bidAmtInput.value.trim()
        }));

        // ✅ Clear input field immediately, not delayed
        bidAmtInput.value = "";

        setTimeout(() => {
            button.disabled = false;
<!--            socket.send(JSON.stringify({ type: 'grouped_bid' }));-->
        }, 300);
    }
}





socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
<!--        console.log("From server:", data);-->

if(data.type==='valid_bid')
{
<!--console.log("valid_bid",data.valid_bid)-->
alert(data.valid_bid);

}

if (data.type === 'timer_update' && data.auction_started===true) {


  let timer = document.getElementById("start_status");
 timer.innerHTML = `
    <span style="color:#007BFF; font-weight:500;">REMAINING TIME:</span><br>
    <span style="color:#FAFAFA; font-size:1.2em; font-weight:600;">${data.minutes}</span>
  `;

  let auction_status = document.getElementById("auction_status");
 auction_status.innerHTML = `
    <span style="color:#007BFF; font-weight:500;">AUCTION STATUS:</span><br>
    <span style="color:#FAFAFA; font-size:1.2em; font-weight:600;">Started</span>
  `;


let current_time_div = document.getElementById("current_time_div");
  current_time_div.innerHTML = `
    <span style="color:#007BFF; font-weight:500;">CURRENT TIME:</span><br>
    <span style="color:#FAFAFA; font-size:1.2em; font-weight:600;">${data.clt}</span>
  `;

 let start_time_div = document.getElementById("start_time_div");
  start_time_div.innerHTML = `
    <span style="color:#007BFF; font-weight:500;">AUCTION START TIME:</span><br>
    <span style="color:#FAFAFA; font-size:1.2em; font-weight:600;">${data.start_time}</span>
  `;


 let end_time_div = document.getElementById("end_time_div");
  end_time_div.innerHTML = `
    <span style="color:#007BFF; font-weight:500;">AUCTION END TIME:</span><br>
    <span style="color:#FAFAFA; font-size:1.2em; font-weight:600;">${data.end_time}</span>
  `;


    // Convert HH:MM:SS to seconds
    function parseTimeToSeconds(timeStr) {
        const parts = timeStr.split(':').map(Number);
        if (parts.length === 3) { // HH:MM:SS
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
        } else if (parts.length === 2) { // MM:SS
            return parts[0] * 60 + parts[1];
        }
        return 0;
    }



    const remainingSeconds = parseTimeToSeconds(data.minutes);
    const totalSeconds = window.totalAuctionSeconds || 600; // default 10 min
    const percent = Math.max(0, (remainingSeconds / totalSeconds) * 100);

    // Update all timers
    document.querySelectorAll('[id^="remaining-time-"]').forEach(timerEl => {
        timerEl.textContent = `Remaining Time: ${data.minutes}`;
    });

    // Update all progress bars
    document.querySelectorAll('[id^="progress-bar-"]').forEach(progressEl => {
        progressEl.style.width = `${percent}%`;

        // Remove old color classes
        progressEl.classList.remove('green', 'orange', 'red');

        // Add new color based on percentage
        if (percent > 50) {
            progressEl.classList.add('green');
        } else if (percent > 20) {
            progressEl.classList.add('orange');
        } else {
            progressEl.classList.add('red');
        }
    });
}
// Inside your onmessage
else if (data.type === 'timer_update' && data.auction_started === false) {
      let timer = document.getElementById("start_status");
  timer.innerHTML = `Auction Will Start In:<br>${data.minutes}`;

<!--    console.log("Auc not started will starts in:", data.minutes);-->
     if(data.seconds===0){
    window.location.reload();
               }


  let auction_status = document.getElementById("auction_status");
 auction_status.innerHTML = `
    <span style="color:#007BFF; font-weight:500;">AUCTION STATUS:</span><br>
    <span style="color:#FAFAFA; font-size:1.2em; font-weight:600;">Will Start Soon....!</span>
  `;


let current_time_div = document.getElementById("current_time_div");
  current_time_div.innerHTML = `
    <span style="color:#007BFF; font-weight:500;">CURRENT TIME:</span><br>
    <span style="color:#FAFAFA; font-size:1.2em; font-weight:600;">${data.clt}</span>
  `;

 let start_time_div = document.getElementById("start_time_div");
  start_time_div.innerHTML = `
    <span style="color:#007BFF; font-weight:500;">AUCTION START TIME:</span><br>
    <span style="color:#FAFAFA; font-size:1.2em; font-weight:600;">${data.start_time}</span>
  `;


 let end_time_div = document.getElementById("end_time_div");
  end_time_div.innerHTML = `
    <span style="color:#007BFF; font-weight:500;">AUCTION END TIME:</span><br>
    <span style="color:#FAFAFA; font-size:1.2em; font-weight:600;">${data.end_time}</span>
  `;




}
else  {
<!--        console.log("Auction Ended");-->
        let timer_ = document.getElementById("start_status");
        timer_.innerHTML = `Auction Ended`;


}

        if (data.type === 'requirements') {

        let total_req_div = document.getElementById("total_req_div");
         total_req_div.innerHTML = `
        <span style="color:#007BFF;font-size:1.3em; font-weight:500;">Total Requirements:</span><br>
        <span style="color:#FAFAFA; font-size:1.3em; font-weight:600;">${data.data.length}</span>`;

<!--        console.log("Auction Start Status:", data.auction_start_status);-->

            renderRequirements(data.data,data.auction_start_status);
        }



           if (data.type === "grouped_bid") {
                    latestUserRanks = data.bid_group_data.user_ranks; // user’s best ranks
                    len_bids = data.bid_group_data.len_bids; // total no of bids
<!--                    console.log("len_bids:",len_bids);-->



                    userBids = data.bid_group_data.bids; // only this user’s bids

<!--                    console.log("latestUserRanks in group_bids :",latestUserRanks);-->
<!--                      console.log("userBids in group_bids:",userBids);-->
                    updateBids();

                    if (len_bids>0){
                    let download_bids_div=document.getElementById("download_bids_div");
                    download_bids_div.style.display="block";

                    }
                }
        };


 function renderRequirements(requirements,auction_start_status) {


<!--        console.log("requirements:", requirements);-->

        const container = document.getElementById('main-container');
<!--        const container = document.getElementById('main-container');-->
        container.innerHTML = ` `;

        requirements.forEach((req, index) => {  // <-- index is here
            const row = document.createElement('div');
            row.className = 'row';
            row.id = `req_row_${req.id}`;



             const leftCol = document.createElement('div');
             leftCol.className = 'col col-left';

            leftCol.innerHTML = `
                <div style="display: flex; align-items: stretch;">
                    <div class="vertical-label">
                        <span>#REQUIREMENT ${index + 1}</span>
                    </div>
                <div class="p-0 d-flex flex-column" style="flex: 1 1 auto; margin:0; padding-bottom: 0; padding-top: 0;">
<!--                    <div style="background-color: white; color: black; border-radius: 1px; margin-top: 0; padding: 0.2rem;">-->
<!--                        <h4 style="margin: 0;"><strong>REQUIREMENT ID:${req.id} </strong> <span id="remaining-time-${req.id}"></span></h2>-->
<!--                    </div>-->




<div class="progress" style="height: 30px; margin-bottom: 10px; position: relative; border-radius: 5px; overflow: hidden;">

  <!-- Shrinking bar -->
  <div id="progress-bar-${req.id}"
       class="progress-bar green"
       style="width: 100%; height: 100%;">
  </div>

  <!-- Fixed text layer (stays in center regardless of bar width) -->
  <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;
              display: flex; align-items: center; justify-content: center;
              font-weight: bold; color: white; pointer-events: none;">
    REQUIREMENT ID: ${req.id} | <span id="remaining-time-${req.id}"></span>
  </div>

</div>




                    <div class="p-1" style="margin-left:0.5rem;">

                           <div class="row no-border">
                           <div class="col-md-6">
<!--                             <div style="display: flex; gap: 10px;">-->

                        <p style="margin:0;"><strong style="color: ${req.loading_point ?  '#05ACFA' : '#EFADF0'};">Loading:</strong> ${req.loading_point || ''}</p>

                      <p style="margin:0;">
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(req.loading_point_full_address || '')};" target="_blank">
                             ${ req.loading_point_full_address}
                            </a>
                        </p>

                        </div>

                         <div class="col-md-6">


                          </div>
                          </div>
                            <p style="margin:0;"><strong style="color: ${req.unloading_point ?  '#05ACFA' : '#EFADF0'};">Unloading:</strong> ${req.unloading_point || ''}</p>


                        <p style="margin:0;">
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(req.unloading_point_full_address || '')};" target="_blank">
                               ${req.unloading_point_full_address}
                            </a>
                        </p>
<!--                        </div>-->

                        <hr>
                        <div style="display: flex; gap: 5px;">
                                          <p style="margin:0;">
                                            <strong style="color: ${req.truck_type ? '#05ACFA' : '#EFADF0'};">Truck:</strong>
                                            ${req.truck_type || ''}
                                          </p>

                                          <p style="margin:0;">
                                            <strong style="color: ${req.no_of_trucks ? '#05ACFA' : '#EFADF0'};">No of Truck:</strong>
                                            ${req.no_of_trucks || ''}
                                          </p>

                                          <p style="margin:0;">
                              <strong style="color: ${req.product ? '#05ACFA' : '#EFADF0'};">
                                Product Type:
                              </strong>
                              ${req.product || ''} with ${req.drum_type_no_of_drums || ''} Drums
                            </p>

                            <p style="margin:0;">
                          <strong style="color: ${req.types ? '#05ACFA' : '#EFADF0'};">
                            Types:
                          </strong>
                          ${req.types || ''}
                        </p>
                                        </div>




                       <div style="display: flex; gap: 5px; margin:2;">
                        <p style="margin:0;">
                              <strong style="color: ${req.approx_mat_mt ? '#05ACFA' : '#EFADF0'};">
                                Approx Material Wait (MT):
                              </strong>
                              ${req.approx_mat_mt || ''}
                            </p>

                             <p style="margin:0;">
                          <strong style="color: ${req.weight_per_drum ? '#05ACFA' : '#EFADF0'};">
                            Weight Per Drum:
                          </strong>
                          ${req.weight_per_drum || ''}
                        </p>




                                              <p style="margin:0;">
                      <strong style="color: ${req.notes ? '#05ACFA' : '#EFADF0'};">
                        Notes:
                      </strong>
                      ${req.notes || ''}
                    </p>
                        </div>
                                                   <hr>
                           <div style="display: flex; gap: 4px;">
                          <p style="margin:0;">
                            <strong style="color: ${req.cel_price ? '#05ACFA' : '#EFADF0'};">
                              Ceiling Price:
                            </strong>
                            ${req.cel_price || ''}
                          </p>

                          <p style="margin:0;">
                            <strong style="color: ${req.min_dec_val ? '#05ACFA' : '#EFADF0'};">
                              Minimal Decremental Value:
                            </strong>
                            ${req.min_dec_val || ''}
                          </p>
                        </div>
                    </div>
                    <hr>
                    <h4 id= "previous_bids_${req.id}"></h4>
                   <p id="user_rank_${req.id}" style="color: lightgreen;"></p>

                  <div id="submit_bid_amt_${req.id}">
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <input type="number" id="bid_amt_${req.id}" placeholder="Enter bid amount"
                                   style="flex: 1; padding: 8px; font-size: 14px;">
                            <button id="submitbid_${req.id}" onclick="submitBid(${req.id})" class="submit-btn"
                                    style="flex: 2; padding: 8px; font-size: 14px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Submit Bid
                            </button>
                        </div>
                    </div>



               </div>

              </div>
            `;

<!--            const rightCol = document.createElement('div');-->
<!--            rightCol.className = 'col col-right';-->

<!--            rightCol.innerHTML = `-->
<!--            <div style="background-color: white; color: black; border-radius: 1px; margin-top: 0; padding: 0.2rem;">-->
<!--                        <h4 style="margin: 0;"><strong>BIDDER REQUIREMENT ID:</strong> ${req.id}</h2>-->
<!--                    </div>-->
<!--                    <div>-->
<!--&lt;!&ndash;                  <h3 id="remaining-time-${req.id}"></h3>&ndash;&gt;-->
<!--                        <div style="height: 40px; display: flex; background-color: transparent;">-->
<!--                          <h3 id="remaining-time-${req.id}" style="margin: 0;"></h3>-->
<!--                        </div>-->
<!--                                          </div>-->

<!--                  <div class="progress" style="height: 12px; margin-bottom: 10px;">-->

<!--                   <div id="progress-bar-${req.id}"-->

<!--                     class="progress-bar green"-->

<!--                         role="progressbar"-->
<!--                         style="width: 100%;"-->
<!--                         aria-valuenow="100"-->
<!--                         aria-valuemin="0"-->
<!--                         aria-valuemax="100">-->
<!--                    </div>-->
<!--                </div>-->
<!--                <hr>-->

<!--                <p id="previous_bids_${req.id}" style="color: yellow;"></p>-->

<!--                <div>-->
<!--                <p id="user_rank_${req.id}" style="color: lightgreen;"></p>-->
<!--                </div>-->


<!--               <div style="margin-top: 5px; display: flex; gap: 2px;">-->
<!--                 <input type="number" id="bid_amt_${req.id}" placeholder="Enter bid amount">-->
<!--                    <button id="submitbid_${req.id}" onclick="submitBid(${req.id})">Submit Bid</button>-->
<!--&lt;!&ndash;                    <button onclick="window.location.reload();">Refresh</button>&ndash;&gt;-->


<!--                </div>-->

<!--            `;-->

            row.appendChild(leftCol);
<!--            If auction is started then only append the right column-->

<!--            if (auction_start_status===true){-->
<!--            row.appendChild(rightCol);-->
<!--            }-->

            if (auction_start_status===true){
           let submit_bid_amt = document.getElementById("submit_bid_amt");
            if (submit_bid_amt) {
                console.log("The element is present");
                submit_bid_amt.style.display = "block";
                          }
            }

            container.appendChild(row);
        });

    requirements.forEach(req => {
        const input = document.getElementById(`bid_amt_${req.id}`);
        if (input) {
            input.value = localStorage.getItem(`bid_amt_${req.id}`) || "";
        }
    });

// Restore input values and focus
<!--function restoreInputs() {-->
<!--    const container = document.getElementById("main-container");-->
<!--    const lastFocusedId = localStorage.getItem("last_focused_input");-->
<!--    const lastCursorPos = parseInt(localStorage.getItem("last_cursor_position"), 10);-->

<!--    // Restore all saved input values-->
<!--    document.querySelectorAll('[id^="bid_amt_"]').forEach(input => {-->
<!--        const savedVal = localStorage.getItem(input.id);-->
<!--        if (savedVal !== null) input.value = savedVal;-->
<!--    });-->

<!--    // Restore focus safely-->
<!--    if (lastFocusedId) {-->
<!--        const focusedInput = document.getElementById(lastFocusedId);-->
<!--        if (focusedInput) {-->
<!--            focusedInput.focus();-->
<!--            // Only try to set cursor if input type allows it-->
<!--            if (!isNaN(lastCursorPos) && focusedInput.type === "text") {-->
<!--                focusedInput.setSelectionRange(lastCursorPos, lastCursorPos);-->
<!--            }-->
<!--        }-->
<!--    }-->
<!--}-->

<!--// Call this after rendering your inputs-->
<!--restoreInputs();-->



// ✅ Delay scroll restore slightly so DOM has time to paint
<!--setTimeout(() => {-->
<!--    // First restore scroll-->
<!--    const lastScrollPos = localStorage.getItem("last_scroll_position");-->
<!--    if (lastScrollPos !== null) {-->
<!--        window.scrollTo(0, parseInt(lastScrollPos, 10));-->
<!--    }-->

<!--    // Then restore focus-->
<!--    const lastFocusedId = localStorage.getItem("last_focused_input");-->
<!--    const lastCursorPos = parseInt(localStorage.getItem("last_cursor_position"), 10);-->
<!--    if (lastFocusedId) {-->
<!--        const focusedInput = document.getElementById(lastFocusedId);-->
<!--        if (focusedInput) {-->
<!--            focusedInput.focus();-->
<!--            if (!isNaN(lastCursorPos) && focusedInput.type === "text") {-->
<!--                focusedInput.setSelectionRange(lastCursorPos, lastCursorPos);-->
<!--            }-->
<!--        }-->
<!--    }-->
<!--}, 100);-->

setTimeout(() => {
    const lastFocusedId = localStorage.getItem("last_focused_input");
    const lastCursorPos = parseInt(localStorage.getItem("last_cursor_position"), 10);

    if (lastFocusedId) {
        // ✅ If user had focused an input, just focus it, do not restore scroll
        const focusedInput = document.getElementById(lastFocusedId);
        if (focusedInput) {
            focusedInput.focus();
            if (!isNaN(lastCursorPos) && focusedInput.type === "text") {
                focusedInput.setSelectionRange(lastCursorPos, lastCursorPos);
            }
        }
    } else {
        // ✅ If no input was focused, restore scroll position
        const lastScrollPos = localStorage.getItem("last_scroll_position");
        if (lastScrollPos !== null) {
            window.scrollTo(0, parseInt(lastScrollPos, 10));
        }
    }
}, 100);



        updateBids();
    }


function updateBids() {


    // Group this user’s bids by requirement
    const bidsByReq = {};
    userBids.forEach(bid => {
        if (!bidsByReq[bid.id]) {   // ✅ use `id` instead of `req_id`
            bidsByReq[bid.id] = [];
        }
        bidsByReq[bid.id].push(bid.rate);
    });

    // Show bid history
    Object.keys(bidsByReq).forEach(reqId => {
        const field = document.getElementById(`previous_bids_${reqId}`);
        if (field) {
            field.textContent = `Rates History: ${bidsByReq[reqId].join(">")}`;
        }
    });

    // Show rank
    latestUserRanks.forEach(rank => {
        const field = document.getElementById(`user_rank_${rank.bid_id}`);  // ✅ use bid_id
        if (field) {
            field.textContent = `Rank: ${rank.rank} (Last Bid: ₹${rank.bid_rate})`;
        }
    });
}
// Save input values in localStorage whenever user types
document.addEventListener("input", (e) => {
    if (e.target.id.startsWith("bid_amt_")) {
        localStorage.setItem(e.target.id, e.target.value);
    }
});

<!--window.addEventListener("beforeunload", () => {-->
<!--    const active = document.activeElement;-->
<!--    if (active && active.tagName === "INPUT" && active.id.startsWith("bid_amt_")) {-->
<!--        localStorage.setItem("last_focused_input", active.id);-->
<!--        localStorage.setItem("last_cursor_position", active.selectionStart);-->
<!--    } else {-->
<!--        localStorage.removeItem("last_focused_input");-->
<!--        localStorage.removeItem("last_cursor_position");-->
<!--    }-->
<!--});-->

<!--// Save last focused input and cursor position immediately on focus-->
<!--document.addEventListener("focusin", (e) => {-->
<!--    if (e.target.tagName === "INPUT" && e.target.id.startsWith("bid_amt_")) {-->
<!--        localStorage.setItem("last_focused_input", e.target.id);-->
<!--        localStorage.setItem("last_cursor_position", e.target.selectionStart || 0);-->
<!--    }-->
<!--});-->
document.addEventListener("focusin", (e) => {
    if (e.target.tagName === "INPUT" && e.target.id.startsWith("bid_amt_")) {
        localStorage.setItem("last_focused_input", e.target.id);
        // Save cursor only if input type is text (number type doesn't support it)
        if (e.target.type === "text") {
            localStorage.setItem("last_cursor_position", e.target.selectionStart || 0);
        }
    }
});

    // Save scroll position before refresh or navigation
window.addEventListener("beforeunload", () => {
    localStorage.setItem("last_scroll_position", window.scrollY);
});



</script>

</body>
</html>
