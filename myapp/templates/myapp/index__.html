<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procure Hub - Bidder Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #111;
            color: white;
            margin: 0;
            padding: 20px;
        }

      header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #1b1b1b;
    padding: 10px 20px;
    border-radius: 6px;
    margin-bottom: 20px;
}

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logout a {
            background: #d9534f;
            padding: 6px 12px;
            border-radius: 4px;
            color: white;
            text-decoration: none;
            transition: background 0.2s ease;
        }
        .logout a:hover {
            background: #c9302c;
        }

        /* MAIN CONTAINER */
        h1 {
            text-align: center;
            margin: 10px 0;
            font-size: 28px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* REQUIREMENT ROWS */
        .row {
            display: flex;
            gap: 20px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #1e1e1e;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s ease;
        }
        .row:hover {
            transform: translateY(-3px);
        }

        /* LEFT COLUMN */
        .col {
            flex: 1;
            padding: 15px;
        }
        .vertical-label {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            background: linear-gradient(180deg, #25ABF5, #1f4061);
            color: white;
            font-weight: bold;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
            font-size: 18px;
        }

        /* TEXT STYLING */
        .col p {
            margin: 6px 0;
        }
        a {
            color: #25ABF5;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }

        /* INPUT & BUTTON */
        input[type="number"] {
            padding: 8px;
            border: none;
            border-radius: 4px;
            background: #333;
            color: white;
            width: calc(100% - 100px);
            margin-right: 10px;
        }
        button {
            background-color: #25ABF5;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        button:hover {
            background-color: #1f8bd1;
        }


    </style>
</head>
<body>

<header>
    <div class="user-info">
        <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=random&color=fff"
             alt="{{ user.username }}"
             style="border-radius: 50%; object-fit: cover;"
             width="30" height="30">
        <span>{{ user.username }}</span>
    </div>
    <div class="logout">
        <a href="{% url 'logout' %}">Logout</a>
    </div>
</header>

<h1>Procure Hub</h1>
<div id="main-container" class="container">
    <h3 style="text-align:center;">BIDDER DASHBOARD</h3>
</div>

<script>
    let allGroupedBids = {};
    let latestUserRanks = [];

    const socket = new WebSocket(`ws://127.0.0.1:8000/ws/chat/room1/`);

    socket.onopen = () => {
        console.log("WebSocket connected");
        socket.send(JSON.stringify({ action: "load_requirements" }));
        socket.send(JSON.stringify({ type: "grouped_bid" }));
    };

    function submitBid(reqId) {
        const button = document.querySelector(`#submitbid_${reqId}`);
        const bidAmtInput = document.getElementById(`bid_amt_${reqId}`);

        if (bidAmtInput && bidAmtInput.value.trim()) {
            button.disabled = true;
            socket.send(JSON.stringify({
                type: 'submit_bid',
                req_id: reqId,
                bid_amt: bidAmtInput.value.trim()
            }));

            setTimeout(() => {
                button.disabled = false;
                bidAmtInput.value = "";
                socket.send(JSON.stringify({ type: 'grouped_bid' }));
            }, 200);
        }
    }

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("From server:", data);
<!--        if(data.type==='bid_end_time'){-->
<!--        console.log("bid_end_time:",data.message);-->
<!--        }-->

        if (data.type === 'requirements') {
<!--            console.log("minutes",data.minutes);-->
<!--            console.log("end_time",data.end_time);-->
            renderRequirements(data.data);
        } else if (data.type === 'grouped_bid') {
            latestUserRanks = data.bid_group_data.user_ranks;
            allGroupedBids = {};
            data.bid_group_data.bids.forEach(bid => {
                if (!allGroupedBids[bid.id]) {
                    allGroupedBids[bid.id] = [];
                }
                allGroupedBids[bid.id].push(bid.rate);
            });
            updateBids();
        }
    };

    function renderRequirements(requirements) {
        const container = document.getElementById('main-container');
        container.innerHTML = '<h3 style="text-align:center;">BIDDER DASHBOARD</h3>';

        requirements.forEach((req, index) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.id = `req_row_${req.id}`;

            const leftCol = document.createElement('div');
            leftCol.className = 'col';
            leftCol.innerHTML = `
                <div style="display: flex; align-items: stretch;">
                    <div class="vertical-label">
                        <span>#REQ ${index + 1}</span>
                    </div>
                    <div style="flex: 1; padding-left: 10px;">
                        <div style="background-color: white; color: black; border-radius: 1px; padding: 0.2rem; margin-bottom: 8px;">
                            <h2 style="margin: 0;"><strong>REQUIREMENT ID:</strong> ${req.id}</h2>
                        </div>
                        <p><strong>1. Loading:</strong> ${req.loading_point || ''}</p>
                        <p><strong>2. Unloading:</strong> ${req.unloading_point || ''}</p>
                        <p><strong>3. Loading Point Full Address:</strong> ${req.loading_point_full_address || ''}</p>
                        <p><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(req.loading_point_full_address || '')}" target="_blank">üìç View Loading Address on Map</a></p>
                        <p><strong>4. Unloading Point Full Address:</strong> ${req.unloading_point_full_address || ''}</p>
                        <p><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(req.unloading_point_full_address || '')}" target="_blank">üìç View Unloading Address on Map</a></p>
                        <hr>
                        <p><strong>5. Truck:</strong> ${req.truck_type || ''}</p>
                        <p><strong>6. No of Truck:</strong> ${req.no_of_trucks || ''}</p>
                        <p><strong>7. Qty:</strong> ${req.qty || ''}</p>
                        <p><strong>8. Product Type:</strong> ${req.product || ''}</p>
                        <p><strong>9. Notes:</strong> ${req.notes || ''}</p>
                        <p><strong>10. Drum Type & No of Drums:</strong> ${req.drum_type_no_of_drums || ''}</p>
                        <p><strong>11. Weight Per Drum:</strong> ${req.weight_per_drum || ''}</p>
                        <p><strong>12. Types:</strong> ${req.types || ''}</p>
                    </div>
                </div>
            `;

            const rightCol = document.createElement('div');
            rightCol.className = 'col';
            rightCol.innerHTML = `
                <p><strong>Bid Req ID:</strong> ${req.id}</p>
                <p id="previous_bids_${req.id}" style="color: yellow;"></p>
                <p id="user_rank_${req.id}" style="color: lightgreen;"></p>
                <div style="display:flex; align-items:center;">
                    <input type="number" id="bid_amt_${req.id}" placeholder="Enter bid amount">
                    <button id="submitbid_${req.id}" onclick="submitBid(${req.id})">Submit</button>
                </div>
            `;

            row.appendChild(leftCol);
            row.appendChild(rightCol);
            container.appendChild(row);
        });

        updateBids();
    }

    function updateBids() {
        Object.keys(allGroupedBids).forEach(reqId => {
            const field = document.getElementById(`previous_bids_${reqId}`);
            if (field) {
                field.textContent = `Previous Bids: ${allGroupedBids[reqId].join(' >> ')}`;
            }
        });

        latestUserRanks.forEach(rank => {
            const field = document.getElementById(`user_rank_${rank.bid_id}`);
            if (field) {
                field.textContent = `Your Rank: ${rank.rank} (Bid: ‚Çπ${rank.bid_rate})`;
            }
        });
    }
</script>

</body>
</html>
